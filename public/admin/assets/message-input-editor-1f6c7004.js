var Vt=Object.defineProperty;var zt=(a,n,o)=>n in a?Vt(a,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):a[n]=o;var z=(a,n,o)=>(zt(a,typeof n!="symbol"?n+"":n,o),o);import{d as Jt,ba as Wt,r as O,aZ as $t,a$ as Gt,w as Qt,o as J,c as W,aB as Yt,y as vt,a_ as xt,aU as Zt,ae as qt}from"./@vue-a164be7a.js";import"./adapter-vue-24f22062.js";import{B as Xt,q as E,o as S,i as x,J as Ct,z as $,_ as jt}from"./@tencentcloud-7fc831ec.js";import{I as Et,E as te,D as ee,P as ne,T as ae,a as se,M as le}from"./@tiptap-57ba56f9.js";import{i as p,a as b}from"./env-a593fd1d.js";import{t as re,p as ie}from"./index-7909557f.js";import{J as ce}from"./type-check-5e73d261.js";import"./tim-upload-plugin-4412696f.js";import"./tim-profanity-filter-plugin-a7e08ee8.js";import"./vue-84471dcb.js";import"./marked-7f3c3653.js";import"./trtc-cloud-js-sdk-6995d964.js";import"./trtc-sdk-v5-5ba82a9e.js";import"./pinia-ec219911.js";import"./mitt-f7ef348c.js";import"./interactjs-0d94d9f4.js";import"./rtc-detect-b2f0fa0a.js";import"./tuicall-engine-webrtc-9ec0a575.js";import"./prosemirror-state-c6000de8.js";import"./prosemirror-model-4222e734.js";import"./orderedmap-1b52af60.js";import"./prosemirror-transform-8a42477f.js";import"./prosemirror-view-88df7d8c.js";import"./prosemirror-keymap-55db6e93.js";import"./w3c-keyname-a25e4cc1.js";import"./prosemirror-commands-6d2c6479.js";import"./prosemirror-schema-list-d5a5352e.js";import"./constant-bad60a54.js";const oe=Et.extend({name:"custom-image",addAttributes(){return{...Et.config.addAttributes(),class:{default:"image",rendered:!1}}},addCommands(){return{setImage:a=>({tr:n,commands:o})=>{var m,d,y;return((y=(d=(m=n.selection)==null?void 0:m.node)==null?void 0:d.type)==null?void 0:y.name)=="custom-image"?o.updateAttributes("custom-image",a):o.insertContent({type:this.name,attrs:a})}}},renderHTML({node:a,HTMLAttributes:n}){var o;return n.class=((o=a.attrs.class)!=null&&o.includes("custom-image-")?"":"custom-image-")+a.attrs.class,["img",n]}});let D="",Q=[],C=[],f=[],L=0,A=!1,Y;const ue={userID:Xt.TYPES.MSG_AT_ALL,nick:"所有人",isAll:!0,avatar:"https://web.sdk.qcloud.com/im/assets/images/at.svg"};E.watch(S.CONV,{currentConversationID:a=>{a!==D&&(D=a,D!=null&&D.startsWith("GROUP")?A=!0:(A=!1,Q=[],C=[],f=[]))}});E.watch(S.CUSTOM,{memberList:a=>{A&&Array.isArray(a)&&(Q=a,C=[ue,...Q],f=C)}});const fe=()=>({allowedPrefixes:null,items:a=>{if(!A)return;const n=C==null?void 0:C.filter(o=>{var m,d,y,k,P,w;return((y=(m=o==null?void 0:o.nick)==null?void 0:m.toLowerCase())==null?void 0:y.startsWith((d=a==null?void 0:a.query)==null?void 0:d.toLowerCase()))||((w=(k=o==null?void 0:o.userID)==null?void 0:k.toLowerCase())==null?void 0:w.startsWith((P=a==null?void 0:a.query)==null?void 0:P.toLowerCase()))});return f=n!=null&&n.length?n:C,x.setShowMemberList(f),f},render:()=>({onStart:a=>{if(!A||(x.toggleAtList(!0),!(a!=null&&a.clientRect)))return;const n=a==null?void 0:a.clientRect();n!=null&&n.left&&(n!=null&&n.top)&&!p&&x.handleAtListPosition({left:n==null?void 0:n.left,top:n==null?void 0:n.top}),Y=a.command},onUpdate(a){if(!A||!(a!=null&&a.clientRect))return;const n=a==null?void 0:a.clientRect();n!=null&&n.left&&(n!=null&&n.top)&&!p&&x.handleAtListPosition({left:n==null?void 0:n.left,top:n==null?void 0:n.top})},onKeyDown(a){var n,o;if(A)return a.event.key==="Enter"&&((n=a.event)==null||n.stopPropagation(),(o=a.event)==null||o.preventDefault()),a.event.key==="Escape"?(x.toggleAtList(!1),f=C,!0):(a==null?void 0:a.event.key)==="ArrowUp"?(de(),!0):(a==null?void 0:a.event.key)==="ArrowDown"?(ge(),!0):(a==null?void 0:a.event.key)==="Enter"?(me(),!0):!1},onExit(){A&&(x.toggleAtList(!1),f=C,x.handleAtListPosition({left:0,top:0}))}})}),de=()=>{f!=null&&f.length&&(L=(L+(f==null?void 0:f.length)-1)%(f==null?void 0:f.length),x.setCurrentSelectIndex(L))},ge=()=>{f!=null&&f.length&&(L=(L+1)%(f==null?void 0:f.length),x.setCurrentSelectIndex(L))},me=()=>{wt(L)},wt=a=>{if(!(f!=null&&f.length))return;const n=f[a];n&&Y&&Y({id:n==null?void 0:n.userID,label:(n==null?void 0:n.nick)||(n==null?void 0:n.userID)})};x.selectItem=wt;const pe=fe,H=class H{constructor(){z(this,"quoteMessageMap",new Map)}static getInstance(){return H.instance||(H.instance=new H),H.instance}setStore(n,o,m,d){var y,k;if(n&&(this.isEditorNotEmpty(o)||(y=d==null?void 0:d.message)!=null&&y.ID)){let P={};(k=d==null?void 0:d.message)!=null&&k.ID&&(this.quoteMessageMap.set(d.message.ID,d.message),P={messageID:d.message.ID,type:d.type});const w={conversationID:n,draftInfo:{html:o,abstract:m,...P}};Ct.setConversationDraft(w),E.update(S.CHAT,"quoteMessage",{message:void 0,type:"quote"})}}getStore(n,o){const m=E.getConversationModel(n);if(m){if(m.conversationID&&m.draftText){const d=ce(m.draftText);E.update(S.CHAT,"quoteMessage",{message:this.quoteMessageMap.get(d.messageID)||void 0,type:d.type}),o(d.html)}Ct.setConversationDraft({conversationID:m.conversationID})}}generateAbstract(n){let o="";return n==null||n.forEach(m=>{switch(m.type){case"text":o+=re(m.payload.text||"");break;case"image":o+=$.t("TUIChat.图片");break;case"video":o+=$.t("TUIChat.视频");break;case"file":o+=$.t("TUIChat.文件");break}}),o}isEditorNotEmpty(n){return n&&!n.includes("is-empty")&&n!=="<p></p>"}};z(H,"instance",null);let Z=H;const G=Z.getInstance(),he={key:0,class:"message-input-mute"},ye=["contenteditable"],ve=Jt({__name:"message-input-editor",props:{placeholder:{type:String,default:"this is placeholder"},replayOrReferenceMessage:{type:Object,default:()=>({})},isMuted:{type:Boolean,default:!0},muteText:{type:String,default:""},enableInput:{type:Boolean,default:!0},enableAt:{type:Boolean,default:!0},enableDragUpload:{type:Boolean,default:!0},enableTyping:{type:Boolean,default:!0}},emits:["sendMessage","onTyping","onAt"],setup(a,{expose:n,emit:o}){const m=a,d=o,{placeholder:y,enableAt:k,enableDragUpload:P,enableTyping:w}=Wt(m),N=O(!0),T=O(!0),M=O(!1),F=O(""),q=O(),h=O();let c=null;const I=new Map;function X(t){F.value!==t&&(F.value&&G.setStore(F.value,lt(),G.generateAbstract(et()),q.value),st(),t&&G.getStore(t,rt)),F.value=t}function j(t){q.value=t}$t(()=>{c=b?new te({element:h.value,extensions:[ee,ne,ae,se.configure({emptyEditorClass:"is-editor-empty",placeholder:y.value}),le.configure({HTMLAttributes:{class:"mention"},suggestion:k.value&&pe()}),oe.configure({inline:!0,allowBase64:!0})],autofocus:!p,editable:!0,injectCSS:!1,editorProps:{transformPastedText(){return""}},onUpdate({editor:t,transaction:e}){var s,l;!w.value||!M.value||(T.value=!t.isFocused,((l=(s=e==null?void 0:e.doc)==null?void 0:s.content)==null?void 0:l.size)>2?N.value=!1:N.value=!0)},onFocus(){var t;if(p&&((t=document==null?void 0:document.getElementById("app"))!=null&&t.style)){const e=document.body.scrollHeight-window.innerHeight;document.getElementById("app").style.marginBottom=`${e}px`,document.getElementById("app").style.height=`calc(100% - ${e}px)`}!w.value||!M.value||(T.value=!0)},onBlur(){var t;p&&((t=document==null?void 0:document.getElementById("app"))!=null&&t.style)&&(document.getElementById("app").style.marginBottom="",document.getElementById("app").style.height="100%"),!(!w.value||!M.value)&&(T.value=!0)}}):null,E.watch(S.CONV,{currentConversationID:X}),E.watch(S.CHAT,{quoteMessage:j})}),Gt(()=>{E.unwatch(S.CONV,{currentConversationID:X}),E.unwatch(S.CHAT,{quoteMessage:j}),I.clear()});function Tt(t){var e;p||(t==null||t.preventDefault(),t==null||t.stopPropagation(),t.keyCode===13&&t.ctrlKey?(e=c==null?void 0:c.commands)==null||e.insertContent("<p></p>"):t.keyCode===13&&d("sendMessage"))}function It(t){var e;p&&(t.data==="@"&&d("onAt",!0),N.value=!((e=h.value)!=null&&e.childNodes))}function bt(){p&&(T.value=!0)}function At(){p&&(T.value=!1)}function St(t){var s;const e=document.createElement("span");e.innerHTML=t.label,e.className="mention",e.id=t.id,(s=h.value)==null||s.appendChild(e)}function kt(t){b&&tt(t,"drop")}function Pt(t){t.clipboardData&&(b&&t.clipboardData.files.length?tt(t,"paste"):(Bt(t),Kt(h.value)))}function Bt(t){var l,i;t.preventDefault();const e=(l=t.clipboardData)==null?void 0:l.getData("text/html"),s=((i=t.clipboardData)==null?void 0:i.getData("text/plain"))||"";if(!e){const u=ie(s);it(u)}}async function tt(t,e){var s,l,i;if(t.preventDefault(),t.stopPropagation(),!(!P.value&&e==="drop")&&(e==="drop"&&t.dataTransfer||e==="paste"&&t.clipboardData)){const u=e==="drop"?(s=t==null?void 0:t.dataTransfer)==null?void 0:s.files:(l=t==null?void 0:t.clipboardData)==null?void 0:l.files;for(let r=0;r<u.length;r++){const g=u[r],B=g.type.startsWith("image/"),U=B?URL.createObjectURL(g):await Rt(g);(i=c==null?void 0:c.commands)==null||i.insertContent({type:"custom-image",attrs:{src:U,alt:g==null?void 0:g.name,class:B?"normal":"file"}}),I.set(U,g),r===u.length-1&&setTimeout(()=>{var R,_;(R=c==null?void 0:c.commands)==null||R.focus("end"),(_=c==null?void 0:c.commands)==null||_.scrollIntoView()},10)}}}const K=new Map,Ut=(t,e)=>new Promise((s,l)=>{if(K.has(e))s(K.get(e));else{const i=new Image;i.crossOrigin="anonymous",i.onload=()=>{K.set(e,i),s(i)},i.onerror=l,i.src=t}}),Rt=async t=>{const{name:e,type:s}=t,l=document.createElement("canvas"),i=160,u=50;l.style.width=i+"px",l.style.height=u+"px";const r=window.devicePixelRatio;l.width=Math.floor(i*r),l.height=Math.floor(u*r);const g=l.getContext("2d");if(!g)return"";g.scale(r,r);const{iconSrc:B,iconType:U}=_t(s),R=await Ut(B,U);g==null||g.drawImage(R,10,10,30,30);const _=Ht(e);return g.fillText(_,45,22),l.toDataURL()},_t=t=>{const e="https://web.sdk.qcloud.com/component/TUIKit/assets/file-",s=["image","pdf","text","ppt","presentation","sheet","zip","word","video","unknown"];let l="",i="";return s.forEach(u=>{t.includes(u)&&(l=e+u+".svg",i=u)}),{iconSrc:l||e+"unknown.svg",iconType:i||"unknown"}},Ht=t=>{if(!t)return t;let e="",s=0;for(let l=0;l<(t==null?void 0:t.length);l++){if(s>16){e+="...";break}e+=t[l],/[a-z]|[0-9]|[,;.!@#-+/\\$%^*()<>?:"'{}~]/i.test(t[l])?s+=1:s+=2}return e};function et(){return b?Lt():Nt()}function Lt(){var s,l;const t=c==null?void 0:c.getJSON(),e=[];if(nt(t,e),e.length>0&&e[e.length-1]&&e[e.length-1].type==="text"&&((l=(s=e[e.length-1].payload)==null?void 0:s.text)!=null&&l.endsWith(`
`))){const i=e[e.length-1].payload.text||"";e[e.length-1].payload.text=i==null?void 0:i.substring(0,i.lastIndexOf(`
`))}return e}function nt(t,e){var s;if(!(!t||!t.type))if(t.type!=="text"&&t.type!=="custom-image"&&t.type!=="mention"){t.type==="paragraph"&&at(t,e),(s=t.content)!=null&&s.length&&t.content.forEach(l=>{nt(l,e)});return}else at(t,e)}function at(t,e){var s,l,i,u,r,g,B,U,R,_,V,ct,ot,ut,ft,dt,gt,mt,pt,ht,yt;if(t.type==="paragraph")e.length>0&&e[e.length-1]&&((s=e[e.length-1])==null?void 0:s.type)==="text"&&(e[e.length-1].payload.text+=`
`);else if(t.type==="text"||t.type==="custom-image"&&((i=(l=t==null?void 0:t.attrs)==null?void 0:l.class)!=null&&i.includes("emoji"))){const v=t.type==="text"?t==null?void 0:t.text:(u=t==null?void 0:t.attrs)==null?void 0:u.alt;e.length>0&&e[e.length-1]&&((r=e[e.length-1])==null?void 0:r.type)==="text"?e[e.length-1].payload.text+=v:e.push({type:"text",payload:{text:v}})}else if(t.type==="custom-image"&&((B=(g=t==null?void 0:t.attrs)==null?void 0:g.class)!=null&&B.includes("normal")))e.push({type:"image",payload:{file:I==null?void 0:I.get((U=t==null?void 0:t.attrs)==null?void 0:U.src)}});else if(t.type==="custom-image"&&((_=(R=t==null?void 0:t.attrs)==null?void 0:R.class)!=null&&_.includes("file"))){const v=I==null?void 0:I.get((V=t==null?void 0:t.attrs)==null?void 0:V.src);e.push({type:(ct=v==null?void 0:v.type)!=null&&ct.includes("video")?"video":"file",payload:{file:v}})}else if(t.type==="mention"){const v="@"+((ot=t==null?void 0:t.attrs)==null?void 0:ot.label)+" ";e.length>0&&e[e.length-1]&&((ut=e[e.length-1])==null?void 0:ut.type)==="text"?e[e.length-1].payload.text+=v:e.push({type:"text",payload:{text:v}}),(dt=(ft=e[e.length-1])==null?void 0:ft.payload)!=null&&dt.atUserList?(ht=(mt=(gt=e[e.length-1])==null?void 0:gt.payload)==null?void 0:mt.atUserList)==null||ht.push((pt=t==null?void 0:t.attrs)==null?void 0:pt.id):e[e.length-1].payload.atUserList=[(yt=t==null?void 0:t.attrs)==null?void 0:yt.id]}}function Nt(){var l,i,u;const t=h.value;let e="";const s=[];try{for(const r of t.childNodes)(r.nodeName==="#text"||r.nodeName==="SPAN"||(l=r.classList)!=null&&l.contains("custom-image-emoji")||(i=r.classList)!=null&&i.contains("mention"))&&(e+=r.nodeValue||r.alt||r.innerHTML||"",(u=r.classList)!=null&&u.contains("mention")&&r.id&&!(s!=null&&s.includes(r.id))&&s.push(r.id))}catch(r){if(r instanceof Error)throw r}return[{type:"text",payload:{text:e,atUserList:s}}]}function Ot(t){var e,s,l,i,u;if(b)(e=c==null?void 0:c.commands)==null||e.insertContent({type:"custom-image",attrs:{src:t==null?void 0:t.url,alt:t==null?void 0:t.emoji.key,title:t==null?void 0:t.emoji.key,class:"emoji"}});else{const r=document.createElement("img");r==null||r.setAttribute("src",t==null?void 0:t.url),r==null||r.setAttribute("class","custom-image custom-image-emoji"),r==null||r.setAttribute("alt",t==null?void 0:t.emoji.key),r==null||r.setAttribute("title",t==null?void 0:t.emoji.key),r==null||r.setAttribute("width","20px"),r==null||r.setAttribute("height","20px"),(s=h.value)==null||s.appendChild(r);const g=document.createElement("span");g.contentEditable="true",(l=h.value)==null||l.appendChild(g)}p||((i=c==null?void 0:c.commands)==null||i.focus(),(u=c==null?void 0:c.commands)==null||u.scrollIntoView())}function Dt(){var t,e;b?(t=c==null?void 0:c.commands)==null||t.blur():(e=h.value)==null||e.blur()}function st(){var t;(t=c==null?void 0:c.commands)==null||t.clearContent(!0),T.value=!0,N.value=!0,p&&(h.value.innerHTML="")}function lt(){return b?c==null?void 0:c.getHTML():h.value.innerHTML}function rt(t){var e;b?(e=c==null?void 0:c.commands)==null||e.setContent(t):h.value.innerHTML=t}function it(t){const e=window.getSelection();if(e&&e.rangeCount){const s=e.getRangeAt(0);t.forEach(l=>{const i=l.type==="image"?Mt(l.emojiKey||"",l.content):Ft(l.content);if(s.insertNode(i),s.setStartAfter(i),l.type==="image"&&p){const u=document.createElement("span");u.contentEditable="true",s.insertNode(u),s.setStartAfter(u)}}),s.collapse(!1),e.removeAllRanges(),e.addRange(s)}}function Ft(t){return document.createTextNode(t)}function Mt(t,e){const s=document.createElement("img");return s.src=e,s.alt=t||"",s.classList.add("custom-image","custom-image-emoji"),s.width=20,s.height=20,s}function Kt(t){const e=window.getSelection();if(e&&e.rangeCount>0){const s=e.getRangeAt(0),l=document.createRange(),i="​",u=document.createTextNode(i);l.setStart(s.startContainer,s.startOffset),l.insertNode(u);const r=l.getBoundingClientRect();u.parentNode&&u.parentNode.removeChild(u),t.scrollTop=r.top-t.getBoundingClientRect().top}}return Qt(()=>[N.value,T.value],(t,e)=>{t!==e&&d("onTyping",N.value,T.value)},{immediate:!0,deep:!0}),n({getEditorContent:et,addEmoji:Ot,resetEditor:st,insertAt:St,setEditorContent:rt,getEditorHTML:lt,insertEditorContent:it,blur:Dt}),(t,e)=>(J(),W("div",{class:qt(["message-input-editor-container",xt(p)&&"message-input-editor-container-h5"])},[a.isMuted?(J(),W("div",he,Yt(a.muteText),1)):vt("",!0),!a.isMuted&&a.enableInput?(J(),W("div",{key:1,ref_key:"editorDom",ref:h,class:"message-input-editor-area",contenteditable:xt(p),onKeydown:Zt(Tt,["enter"]),onDrop:kt,onPaste:Pt,onInput:It,onBlur:bt,onFocus:At},null,40,ye)):vt("",!0)],2))}});const Qe=jt(ve,[["__scopeId","data-v-3818f330"]]);export{Qe as default};
