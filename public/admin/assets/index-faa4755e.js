var tt=Object.defineProperty;var st=(w,c,v)=>c in w?tt(w,c,{enumerable:!0,configurable:!0,writable:!0,value:v}):w[c]=v;var Y=(w,c,v)=>(st(w,typeof c!="symbol"?c+"":c,v),v);import{d as ot,r as l,b as _e,aZ as we,a$ as at,b7 as Pe,w as nt,o as i,c as O,a as b,a_ as o,aB as $,y as T,x as u,F as lt,ao as it,M as A,ae as oe,aW as rt,aR as L}from"./@vue-a164be7a.js";import"./adapter-vue-24f22062.js";import{i as Le,q as h,o as C,B as ct,R as ut,r as gt,X as Re,z as q,T as Oe,P as mt,E as pt,I as dt,_ as ft}from"./@tencentcloud-7fc831ec.js";import{l as Mt}from"./lodash-f986f62a.js";import ht from"./index-7f4dadfc.js";import vt from"./message-text-fa779d57.js";import It from"./message-image-5b640b78.js";import St from"./message-audio-c2671f84.js";import{M as Tt}from"./index-79ddaf2a.js";import Ct from"./message-file-66d98bfb.js";import yt from"./message-face-a8df59a3.js";import Dt from"./message-custom-f995a3d6.js";import Et from"./message-tip-5fd87ded.js";import kt from"./message-bubble-03765614.js";import _t from"./message-location-f4d00aa4.js";import wt from"./message-timestamp-4c57a5eb.js";import Pt from"./message-video-ab63f1fe.js";import Lt from"./index-27a06473.js";import Rt from"./message-revoked-5cb51986.js";import{i as Ot,M as bt}from"./message-plugin-b82b97f2.js";import At from"./index-fd7f70ae.js";import Gt from"./index-9d4666cb.js";import Bt from"./index-1dfefc7d.js";import Ht from"./index-f37edc42.js";import ae from"./index-944a8f08.js";import{e as be}from"./index-7909557f.js";import{c as Ae,a as ne,i as Ge}from"./env-a593fd1d.js";import{i as Be,a as Ut,d as xt,s as Nt}from"./utils-14df48f1.js";import"./tim-upload-plugin-4412696f.js";import"./tim-profanity-filter-plugin-a7e08ee8.js";import"./vue-84471dcb.js";import"./marked-7f3c3653.js";import"./trtc-cloud-js-sdk-6995d964.js";import"./trtc-sdk-v5-5ba82a9e.js";import"./pinia-ec219911.js";import"./mitt-f7ef348c.js";import"./interactjs-0d94d9f4.js";import"./rtc-detect-b2f0fa0a.js";import"./tuicall-engine-webrtc-9ec0a575.js";import"./Icon-2c0593f3.js";import"./index-6b0c1d9b.js";import"./index-95ee9b8a.js";import"./index-cfa97a9d.js";import"./close-dark-98fe05f7.js";import"./back-16f17fde.js";import"./video-play-6934d780.js";import"./message-container-d845128f.js";import"./files-37ebf78f.js";import"./type-check-5e73d261.js";import"./constant-bad60a54.js";import"./star-light-645157ed.js";import"./index-63059e66.js";import"./config-58aee8b5.js";import"./index-7077c717.js";import"./index-cfdb213d.js";import"./index-e4ac2ab7.js";import"./index-e69feb26.js";import"./translation-content-19d02e38.js";import"./index-1a28bf3f.js";import"./convert-content-ac4eeb47.js";import"./index-c630b3a2.js";import"./icon-close-7ee462f2.js";import"./enableSampleTaskStatus-a12ec87d.js";import"./message-plugin-layout-b05ad9de.js";import"./message-call-group-b36cd21c.js";import"./message-call-c2c-215680ac.js";import"./index-0978e08a.js";import"./message-customer-service-0c77f761.js";import"./message-room-default-e8ce0c6a.js";import"./index-315de94f.js";import"./image-item.vue_vue_type_style_index_0_lang-58c86db8.js";const Ft={product:{label:"产品文档",url:"https://cloud.tencent.com/document/product/269/1499#.E7.BE.A4.E7.BB.84.E5.8A.9F.E8.83.BD"},customMessage:{label:"自定义消息",url:"https://web.sdk.qcloud.com/im/doc/zh-cn/SDK.html#createCustomMessage"},complaint:{label:"点此投诉",url:"https://cloud.tencent.com/apply/p/xc3oaubi98g"},implement:{label:"集成TUICallKit",url:"https://cloud.tencent.com/document/product/269/79861"},purchase:{label:"开通腾讯实时音视频服务",url:"https://cloud.tencent.com/document/product/1640/79968"}},jt=Ft,M=class M{constructor(){Y(this,"chatStorage",null)}static getInstance(){return M.instance||(M.instance=new M),M.instance}getChatStorage(c){if(this.chatStorage||(this.chatStorage=this.getChatStorageFromLocalStorage()),c)return this.chatStorage[c];throw new Error("No key provided")}setChatStorage(c,v){this.chatStorage||(this.chatStorage=this.getChatStorageFromLocalStorage()),this.chatStorage[c]=v;try{Ae?Le.setStorageSync(M.CHAT_STORAGE_KEY,JSON.stringify(this.chatStorage)):localStorage.setItem(M.CHAT_STORAGE_KEY,JSON.stringify(this.chatStorage))}catch{throw new Error("Fail to set chat storage")}}getChatStorageFromLocalStorage(){let c="";if(Ae?c=Le.getStorageSync(M.CHAT_STORAGE_KEY)||"":c=localStorage.getItem(M.CHAT_STORAGE_KEY)||"",!c)return{};try{this.chatStorage=JSON.parse(c)}catch{this.chatStorage={}}return this.chatStorage}};Y(M,"instance",null),Y(M,"CHAT_STORAGE_KEY","TUI_CHAT_STORAGE");let ie=M;const le=ie.getInstance(),Vt={key:0,class:"tui-chat-safe-tips"},Yt=["id"],$t={class:"message-item"},qt=["onLongpress","onContextmenu","onTouchstart","onTouchend","onMouseover"],Jt={class:"delDialog-title"},Kt=ot({__name:"index",props:{isGroup:{type:Boolean,default:!1},groupID:{default:""},isNotInGroup:{type:Boolean,default:!1},isMultipleSelectMode:{type:Boolean,default:!1}},emits:["closeInputToolBar","toggleMultipleSelectMode","handleEditor"],setup(w,{expose:c,emit:v}){const U=v,I=w;let J,m=null;const K=new Set,He=h.getData(C.APP,"isOfficial"),Ue=h.getData(C.APP,"enabledEmojiPlugin"),g=l(),X=l(),p=l(),xe=l(),E=l([]),re=l(!1),ce=l(""),z=l(),Ne=l(),G=l(""),d=l(ct.TYPES),W=l(!1),y=l(),Z=l(),ue=l(),P=l([]),Q=l(),ge=l(!1),ee=l(),x=l(0),me=l(!1),k=l({}),N=l(!1),F=l(),Fe=_e(()=>{var t;return(t=p==null?void 0:p.value)==null?void 0:t.filter(s=>!s.isRevoked&&!s.hasRiskContent&&s.type===d.value.MSG_IMAGE)}),R=l(!1),pe=l(),de=_e(()=>ut.getExtensionList(gt.TUIChat.EXTENSION.MSG_POP_MENU.EXT_ID,{enabledEmojiPlugin:Ue}).some(s=>s.text==="TUIEmojiPlugin"));we(()=>{k.value=le.getChatStorage("audioPlayedMapping")||{},h.watch(C.CHAT,{messageList:fe,messageSource:Me,isCompleted:he}),h.watch(C.CONV,{currentConversationID:Ie}),h.watch(C.CUSTOM,{isShowMessagePopMenu:ve})}),we(()=>{var t;(t=g.value)==null||t.addEventListener("scroll",ye)}),at(()=>{var t;h.unwatch(C.CHAT,{messageList:fe,messageSource:Me,isCompleted:he}),h.unwatch(C.CONV,{currentConversationID:Ie}),h.unwatch(C.CUSTOM,{isShowMessagePopMenu:ve}),(t=g.value)==null||t.removeEventListener("scroll",ye),Object.keys(k.value).length>0&&le.setChatStorage("audioPlayedMapping",k.value),K.clear(),m==null||m.disconnect(),m=null});async function fe(t){var n,f,D,S,_;m==null||m.disconnect();const s=z.value;let e=!1;if(xe.value=t,p.value=t.filter(r=>{var H;return(H=r.reactionList)!=null&&H.length&&!r.isDeleted&&(e=!0),!r.isDeleted}),!((n=p.value)!=null&&n.length)){z.value={};return}const a=(D=p.value)==null?void 0:D[((f=p.value)==null?void 0:f.length)-1];if(y.value){if(((S=p.value)==null?void 0:S.findIndex(r=>{var H;return(r==null?void 0:r.ID)===((H=y.value)==null?void 0:H.ID)}))>=0){const r=y.value;y.value=void 0,await B({scrollToMessage:r}),await V(r==null?void 0:r.ID)}}else if(x.value)await B({scrollToOffset:{bottom:x.value}}),x.value=0;else{if((_=Q.value)!=null&&_.isScrollButtonVisible&&(a==null?void 0:a.flow)==="in")return;a!=null&&a.ID&&JSON.stringify(s)!==JSON.stringify(a)?await B({scrollToBottom:!0}):e&&je()&&await B({scrollToBottom:!0})}z.value=Object.assign({},a),Be()&&Pe(()=>ze())}function je(){return g.value&&typeof g.value.scrollTop=="number"&&typeof g.value.scrollHeight=="number"&&typeof g.value.clientHeight=="number"&&Math.ceil(g.value.scrollTop+g.value.clientHeight)>=g.value.scrollHeight}async function B(t={}){return new Promise((s,e)=>{requestAnimationFrame(()=>{var n,f,D;g.value||e();const a=g.value;if(t.scrollToBottom)a.scrollTop=a.scrollHeight;else if(t.scrollToMessage){const S=(n=Z.value)==null?void 0:n.find(_=>{var r;return(_==null?void 0:_.id)===`tui-${(r=t.scrollToMessage)==null?void 0:r.ID}`});S!=null&&S.scrollIntoView&&S.scrollIntoView({behavior:"smooth",block:"nearest"})}else t.scrollToOffset&&((f=t.scrollToOffset)!=null&&f.top?a.scrollTop=t.scrollToOffset.top:(D=t.scrollToOffset)!=null&&D.bottom&&(a.scrollTop=a.scrollHeight-t.scrollToOffset.bottom));s()})})}async function Me(t){var s;if(y.value=t,y.value&&((s=p.value)==null?void 0:s.findIndex(e=>{var a;return(e==null?void 0:e.ID)===((a=y.value)==null?void 0:a.ID)}))>=0){const e=y.value;y.value=void 0,await B({scrollToMessage:e}),await V(e==null?void 0:e.ID)}}function he(t){re.value=t}function ve(t){t||(G.value="")}const Ie=t=>{if(ce.value=t,ce.value||(p.value=[]),Be()){const{groupProfile:s}=h.getConversationModel(t)||{};J=s==null?void 0:s.type}Object.keys(k.value).length>0&&le.setChatStorage("audioPlayedMapping",k.value)},Ve=()=>{var t;Re.getMessageList().then(s=>{const{nextReqMessageID:e}=s.data;Ne.value=e}),x.value=(t=g.value)==null?void 0:t.scrollHeight},Ye=t=>{window.open(t.url)},$e=t=>{N.value||F.value||W.value||(N.value=!0,F.value=t)},qe=()=>{N.value=!1,F.value=null},te=(t,s,e=!1)=>{I.isMultipleSelectMode||I.isNotInGroup||(e&&(W.value=!0),G.value=s.ID,Se(t.target))},Je=(t,s)=>{var e;I.isMultipleSelectMode||I.isNotInGroup||ne&&(G.value=s.ID,ue.value=(e=Z.value)==null?void 0:e.find(a=>(a==null?void 0:a.id)===`tui-${s.ID}`),Pe(()=>{var n;const a=X.value&&((n=X.value[0])==null?void 0:n.messageToolDom);dt.listen({domRefs:ue.value,ignoreDomRefs:a,handler:Ee,button:t.button}),Se(t.target)}))};function Se(t){const s=document.getElementById("tui-chat-main"),e=160,a=t.getBoundingClientRect(),n=s.getBoundingClientRect();me.value=a.top-n.top<e}let se;const j=(t,s,e)=>{if(I.isMultipleSelectMode||I.isNotInGroup||!Ge)return;function a(){clearTimeout(se),te(t,s)}function n(){se=setTimeout(a,500)}function f(){clearTimeout(se)}switch(e){case"touchstart":n();break;case"touchend":f(),setTimeout(()=>{W.value=!1},200);break}},Ke=t=>{U("handleEditor",t,"reedit")},Te=t=>{R.value=!0,pe.value=t},Xe=()=>{R.value=!R.value,pe.value.resendMessage()};function V(t){return new Promise(s=>{if(P.value.indexOf(t)<0){P.value.push(t);const a=setTimeout(()=>{P.value.splice(P.value.indexOf(t),1),clearTimeout(a),s()},3e3)}})}async function Ce(){const{scrollHeight:t}=await mt("#messageScrollList"),{height:s}=await pt("#messageScrollList");g.value&&(g.value.scrollTop=t-s)}const ye=Mt.throttle(function(t){var s;(s=Q.value)==null||s.judgeScrollOverOneScreen(t)},150,{leading:!0});async function ze(){var e;if(!p.value||!g.value||p.value.length===0||J===d.value.GRP_AVCHATROOM||J===d.value.GRP_COMMUNITY)return;const t={};m==null||m.disconnect(),m=new IntersectionObserver(a=>{a.forEach(n=>{var S;const{isIntersecting:f,target:D}=n;if(f){const{msgDom:_,msgModel:r}=t[D.id];r&&!((S=r.readReceiptInfo)!=null&&S.isPeerRead)&&!K.has(r.ID)&&(Re.sendMessageReadReceipt([r]),K.add(r.ID),m==null||m.unobserve(_))}})},{root:g.value,threshold:.7});const s=(e=g.value)==null?void 0:e.querySelectorAll(".message-li");if(s)for(let a=0;a<(s==null?void 0:s.length);++a){const n=s[a],f=p.value.find(D=>n.id.slice(4)===D.ID);f&&f.needReadReceipt&&f.flow==="in"&&(t[n.id]={msgDom:n,msgModel:f},m==null||m.observe(n))}}function De(t,s){t&&I.isNotInGroup||(t?ee.value=s:ee.value=void 0,ge.value=t)}function Ee(){G.value=""}function We(){U("closeInputToolBar")}nt(()=>I.isMultipleSelectMode,t=>{t||ke({type:"clearAll",messageID:""})});function ke({type:t,messageID:s}){t==="clearAll"?E.value=[]:t==="add"&&!E.value.includes(s)?E.value.push(s):t==="remove"&&(E.value=E.value.filter(e=>e!==s))}function Ze(){h.update(C.CUSTOM,"multipleForwardMessageID",{isMergeForward:!0,messageIDList:E.value})}function Qe(){h.update(C.CUSTOM,"multipleForwardMessageID",{isMergeForward:!1,messageIDList:E.value})}function et(t){k.value={...k.value,[t]:!0}}return c({oneByOneForwardMessage:Qe,mergeForwardMessage:Ze,scrollToLatestMessage:Ce}),(t,s)=>(i(),O("div",{class:oe(["tui-chat",[o(Ge)?"tui-chat-h5":""]])},[b("div",{id:"tui-chat-main",class:"tui-chat-main",onClick:Ee},[o(He)?(i(),O("div",Vt,[b("span",null,$(o(q).t("TUIChat.【安全提示】本 APP 仅用于体验腾讯云即时通信 IM 产品功能，不可用于业务洽谈与拓展。请勿轻信汇款、中奖等涉及钱款的信息，勿轻易拨打陌生电话，谨防上当受骗。")),1),b("a",{onClick:s[0]||(s[0]=e=>Ye(o(jt).complaint))},$(o(q).t("TUIChat.点此投诉")),1)])):T("",!0),t.isGroup?(i(),u(ht,{key:I.groupID,groupID:I.groupID},null,8,["groupID"])):T("",!0),b("ul",{id:"messageScrollList",ref_key:"messageListRef",ref:g,class:"tui-message-list",onClick:We},[o(re)?T("",!0):(i(),O("p",{key:0,class:"message-more",onClick:Ve},$(o(q).t("TUIChat.查看更多")),1)),(i(!0),O(lt,null,it(o(p),(e,a)=>(i(),O("li",{id:"tui-"+e.ID,key:e.ID,ref_for:!0,ref_key:"messageElementListRef",ref:Z,class:"message-li"},[A(wt,{currTime:e.time,prevTime:a>0?o(p)[a-1].time:0},null,8,["currTime","prevTime"]),b("div",$t,[e.type===o(d).MSG_GRP_TIP||o(Ut)(e)?(i(),u(Et,{key:0,content:e.getMessageContent(),blinkMessageIDList:o(P),onBlinkMessage:V},null,8,["content","blinkMessageIDList"])):e.isRevoked?(i(),u(Rt,{key:1,isEdit:e.type===o(d).MSG_TEXT,messageItem:e,onMessageEdit:n=>Ke(e)},null,8,["isEdit","messageItem","onMessageEdit"])):o(Ot)(e)?(i(),u(bt,{key:2,message:o(xt)(e),blinkMessageIDList:o(P),onResendMessage:Te,onHandleToggleMessageItem:te,onHandleH5LongPress:j},null,8,["message","blinkMessageIDList"])):(i(),O("div",{key:3,class:oe({"message-event-bind-div":!0}),onLongpress:n=>te(n,e,!0),onContextmenu:rt(n=>Je(n,e),["prevent","right"]),onTouchstart:n=>j(n,e,"touchstart"),onTouchend:n=>j(n,e,"touchend"),onMouseover:n=>j(n,e,"touchend")},[A(kt,{content:e.getMessageContent(),isAudioPlayed:!!o(k)[e.ID],blinkMessageIDList:o(P),isMultipleSelectMode:t.isMultipleSelectMode,messageItem:JSON.parse(JSON.stringify(e)),multipleSelectedMessageIDList:o(E),onBlinkMessage:V,onResendMessage:n=>Te(e),onChangeSelectMessageIDList:ke,onSetReadReceiptPanelVisible:De},{messageElement:L(()=>[e.type===o(d).MSG_TEXT?(i(),u(vt,{key:0,content:e.getMessageContent()},null,8,["content"])):e.type===o(d).MSG_IMAGE?(i(),u(ae,{key:1,content:e.getMessageContent(),messageItem:e},{default:L(()=>[A(It,{content:e.getMessageContent(),messageItem:e,onPreviewImage:$e},null,8,["content","messageItem"])]),_:2},1032,["content","messageItem"])):e.type===o(d).MSG_VIDEO?(i(),u(ae,{key:2,content:e.getMessageContent(),messageItem:e},{default:L(()=>[A(Pt,{content:e.getMessageContent(),messageItem:e},null,8,["content","messageItem"])]),_:2},1032,["content","messageItem"])):e.type===o(d).MSG_AUDIO?(i(),u(St,{key:3,content:e.getMessageContent(),messageItem:e,onSetAudioPlayed:et},null,8,["content","messageItem"])):e.type===o(d).MSG_FILE?(i(),u(ae,{key:4,content:e.getMessageContent(),messageItem:e},{default:L(()=>[A(Ct,{content:e.getMessageContent(),messageItem:e},null,8,["content","messageItem"])]),_:2},1032,["content","messageItem"])):e.type===o(d).MSG_MERGER?(i(),u(Tt,{key:5,renderData:e.payload,messageItem:e},null,8,["renderData","messageItem"])):e.type===o(d).MSG_FACE?(i(),u(yt,{key:6,content:e.getMessageContent()},null,8,["content"])):e.type===o(d).MSG_LOCATION?(i(),u(_t,{key:7,content:e.getMessageContent()},null,8,["content"])):e.type===o(d).MSG_CUSTOM?(i(),u(Dt,{key:8,content:e.getMessageContent(),messageItem:e},null,8,["content","messageItem"])):T("",!0)]),TUIEmojiPlugin:L(()=>[o(de)&&e.reactionList.length>0?(i(),u(o(Oe),{key:0,type:"reaction-detail",emojiConfig:o(be),message:o(Nt)(e)},null,8,["emojiConfig","message"])):T("",!0)]),_:2},1032,["content","isAudioPlayed","blinkMessageIDList","isMultipleSelectMode","messageItem","multipleSelectedMessageIDList","onResendMessage"])],40,qt)),e.ID===o(G)?(i(),u(Lt,{key:4,ref_for:!0,ref_key:"messageToolListRef",ref:X,class:oe({"message-tool":!0,"message-tool-out":e.flow==="out","message-tool-in":e.flow==="in","message-tool-bottom":o(me)}),messageItem:e,isMultipleSelectMode:t.isMultipleSelectMode,onToggleMultipleSelectMode:s[1]||(s[1]=()=>U("toggleMultipleSelectMode"))},{TUIEmojiPlugin:L(()=>[o(de)?(i(),u(o(Oe),{key:0,message:e,emojiConfig:o(be)},null,8,["message","emojiConfig"])):T("",!0)]),_:2},1032,["class","messageItem","isMultipleSelectMode"])):T("",!0)])],8,Yt))),128))],512),A(At,{ref_key:"scrollButtonInstanceRef",ref:Q,onScrollToLatestMessage:Ce},null,512),o(R)?(i(),u(Bt,{key:2,class:"resend-dialog",show:o(R),isH5:!o(ne),center:!0,isHeaderShow:o(ne),onSubmit:s[2]||(s[2]=e=>Xe()),"onUpdate:show":s[3]||(s[3]=e=>R.value=e)},{default:L(()=>[b("p",Jt,$(o(q).t("TUIChat.确认重发该消息？")),1)]),_:1},8,["show","isH5","isHeaderShow"])):T("",!0),o(N)?(i(),u(Ht,{key:3,currentImage:o(F),imageList:o(Fe),onClose:qe},null,8,["currentImage","imageList"])):T("",!0),o(ge)?(i(),u(Gt,{key:4,message:Object.assign({},o(ee)),onSetReadReceiptPanelVisible:De},null,8,["message"])):T("",!0)])],2))}});const po=ft(Kt,[["__scopeId","data-v-d42b96de"]]);export{po as default};
