var U=Object.defineProperty;var W=(g,a,e)=>a in g?U(g,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):g[a]=e;var y=(g,a,e)=>(W(g,typeof a!="symbol"?a+"":a,e),e);import"./adapter-vue-24f22062.js";import{q as E,X as M,B as P,z as I,W as V,h as _,_ as A}from"./@tencentcloud-7fc831ec.js";import{d as z,r as f,w as F,o as m,c as d,a_ as u,ae as x,F as b,ao as $,aB as k,L as q,y as H,a as O,ag as X,b7 as w}from"./@vue-a164be7a.js";import"./tim-upload-plugin-4412696f.js";import"./tim-profanity-filter-plugin-a7e08ee8.js";import"./vue-84471dcb.js";import"./marked-7f3c3653.js";import"./trtc-cloud-js-sdk-6995d964.js";import"./trtc-sdk-v5-5ba82a9e.js";import"./pinia-ec219911.js";import"./mitt-f7ef348c.js";import"./interactjs-0d94d9f4.js";import"./rtc-detect-b2f0fa0a.js";import"./tuicall-engine-webrtc-9ec0a575.js";const v=class v{constructor(){y(this,"isUseCache",!0);y(this,"translationCache",new Map)}static getInstance(){return v.instance||(v.instance=new v),v.instance}async get(a){if(this.isUseCache){const s=this.translationCache.get(a.ID);if(s!==void 0)return s}const e=E.getMessageModel(a.ID);if(!e)return[];const{text:n}=e.getMessageContent()||{},t=[],l=await this.getNickList(e);for(let s=0;s<n.length;++s){const h=n[s];if(h.name==="img"){t.push({type:"face",value:h.src});continue}const{transSplitingList:C,atNickList:p}=this.getSplitResult(h.text,l);for(let r=0;r<C.length;++r)t.push({type:"text",value:C[r]}),r<p.length&&t.push({type:"mention",value:p[r]})}const i=[],o=t.filter((s,h)=>s.type==="text"&&s.value.trim()!==""?(i.push(h),!0):!1).map(s=>s.value);return o.length===0?(this.translationCache.set(e.ID,t),t):((await this.getTranslationStandard(o)).forEach((s,h)=>{t[i[h]].value=s}),this.translationCache.set(e.ID,t),t)}clear(){this.translationCache.clear()}disableCache(){this.isUseCache=!1}enableCache(){this.isUseCache=!0}getTranslationStandard(a){return new Promise((e,n)=>{M.translateText({sourceTextList:a,sourceLanguage:"auto"}).then(t=>{const{data:{translatedTextList:l}}=t;e(l)}).catch(t=>{n(t)})})}async getNickList(a){const e=[],{atUserList:n=[]}=a,t=P.TYPES.MSG_AT_ALL;if(n.includes(t)&&e.push(`@${I.t("TUIChat.所有人")}`),n.length>0){const{data:l}=await V.getUserProfile({userIDList:n});l.forEach(i=>{const o=`@${i.nick||i.userID}`;e.push(o)})}return[...new Set(e)]}getSplitResult(a,e){let n=0;const t=[],l=[];for(;n<a.length;){const i=a.indexOf("@",n);if(i===-1){t.push(a.substring(n));break}let o=!1;for(let c=0;c<e.length;++c){const s=a.indexOf(e[c],i);if(s!==-1&&s===i){t.push(a.substring(n,s)),l.push(e[c]),n=s+e[c].length,o=!0;break}}if(!o){t.push(a.substring(n));break}}return{transSplitingList:t,atNickList:l}}};y(v,"instance");let T=v;const j=T.getInstance(),G=["src"],Y={key:1,class:"text-plain"},J=z({__name:"translation-content",props:{message:{default:()=>({})},translationContentVisible:{type:Boolean},isSingleTranslation:{type:Boolean},translationWrapperRef:{}},emits:["toggleErrorStatus"],setup(g,{emit:a}){const e=a,n=g,t=f(!1),l=f(""),i=f([]),o=f(0),c=f(0),s=f(),h=f();return F(()=>n.translationContentVisible,C=>{C&&j.get(n.message).then(p=>{t.value=!0,i.value=p,w(()=>{const{height:r,width:L}=_(s.value),{height:S,width:R}=_(h.value);o.value=r,c.value=L,requestAnimationFrame(()=>{o.value=S,c.value=R,n.isSingleTranslation&&w(()=>{const{bottom:B}=_(n.translationWrapperRef),{bottom:D}=_("#messageScrollList");if(B>D){const N=setTimeout(()=>{n.translationWrapperRef.scrollIntoView({block:"end",behavior:"smooth"}),clearTimeout(N)},150)}})})})}).catch(p=>{t.value=!0;const{height:r}=_(s.value);o.value=r,i.value=[],e("toggleErrorStatus",!0),l.value=p.message})},{immediate:!0}),(C,p)=>(m(),d("div",{class:"message-translation-container",style:X({height:u(o)>0?`${u(o)}px`:"auto",width:u(c)>0?`${u(c)}px`:"auto"})},[u(t)?(m(),d("div",{key:0,ref_key:"translationContentRef",ref:h,class:x({"translation-content":!0,occur:u(o)>0})},[u(i).length>0?(m(!0),d(b,{key:0},$(u(i),(r,L)=>(m(),d("span",{key:L},[r.type==="face"?(m(),d("img",{key:0,class:"text-face",src:r.value},null,8,G)):(m(),d("span",Y,k(r.value),1))]))),128)):(m(),d(b,{key:1},[q(k(u(l)),1)],64))],2)):H("",!0),O("div",{ref_key:"translationLoadingRef",ref:s,class:x({loading:!0,"loading-end":u(t)})},k(u(I).t("TUIChat.翻译中"))+"... ",3)],4))}});const gt=A(J,[["__scopeId","data-v-ca204013"]]);export{gt as default};
