import{W as e,I as t,J as i,K as o,L as n,g as a,M as s,N as r,O as c,P as l,$ as u,Q as d,R as h,S as m,T as p,U as f,A as g,V as _,X as C,o as v,p as w,f as y,w as k,c as x,j as I,F as b,i as M,h as T,Z as j,_ as S,a as L,q as U,t as V,E as B,e as $,H as W,d as H,Y as N,a0 as z,n as R}from"./index-40b5c4cd.js";import{_ as E}from"./cloud-image.bb0ddc22.js";import{_ as G}from"./uni-icons.4f8d1bfc.js";import{_ as P,a as D}from"./uni-list-item.88aca6c2.js";import{c as F,n as J,a as O,g as Q,b as q,d as A,e as K,_ as X}from"./info.ed04b221.js";import{_ as Y}from"./uni-list-chat.abf53d2c.js";import{_ as Z}from"./uni-load-more.0f0e0cfa.js";import{_ as ee}from"./uni-list.8cb35de1.js";import{_ as te}from"./tabbar.vue_vue_type_script_setup_true_lang.45a154e4.js";import ie from"./uni_modules-uni-im-pages-chat-chat.bf00f51b.js";import{_ as oe}from"./_plugin-vue_export-helper.1b428a4d.js";import"./uni-popup-dialog.91400977.js";import"./uni-popup.52abe24b.js";import"./u-icon.4067ae16.js";import"./u-badge.a768d844.js";import"./util.b50fc651.js";const ne=e.database();let ae=!1,se=0;const re=oe({components:{chatView:ie,"uni-im-contacts":F,"uni-im-notification":J,"uni-im-addPeopleGroups":O,"uni-im-groupList":Q,"uni-im-createGroup":q,"uni-im-chat-info":A,"uni-im-group-info":K},data:()=>({wHeight:"auto",userInfo:{},dynamicComponentName:"uni-im-addPeopleGroups",view2Title:"加人/加群",showContactsView:!1,chatInfoIsShow:!1,currentConversation:{}}),computed:{conversationList(){se++;let e=t.conversation.dataList;return setTimeout((()=>{se=0}),1e3),se>6?e:e.sort((function(e,i){if(i.id==t.currentConversationId)return 0;i.chatText&&(i.update_time=Date.now());let o=e.update_time||0,n=i.update_time||0,a=e.msgList.length,s=i.msgList.length;if(a){let t=e.msgList[a-1].create_time;t>o&&(o=t)}if(s){let e=i.msgList[s-1].create_time;e>n&&(n=e)}return n-o}))},loadMoreContentText(){return{contentrefresh:"正在加载...",contentnomore:this.conversationList.length?"没有更多数据了":"没有会话数据"}},conversationHasMore:()=>t.conversation.hasMore,...t.mapState(["currentConversationId","isWidescreen"]),unreadMsgCount:()=>t.conversation.unreadCount(),unreadnotificationCount:()=>t.notification.unreadCount(),currentUserInfo:()=>i.userInfo,avatarUrl(){return this.currentUserInfo.avatar_file&&this.currentUserInfo.avatar_file.url?this.currentUserInfo.avatar_file.url:"/uni_modules/uni-im/static/avatarUrl.png"}},watch:{unreadMsgCount(e){console.log({unreadMsgCount:e}),0==e?o({index:0,complete:e=>{console.log(e)}}):n({index:0,text:e+"",complete:e=>{}})},showContactsView(e){e?(ae=this.currentConversationId,t.currentConversationId=!1):ae&&(t.currentConversationId=ae,this.$nextTick((()=>{this.toChat(ae)})))},async currentConversationId(e){this.currentConversation=await t.conversation.get(e)}},created(){this.wHeight=a().windowHeight-50+"px",console.log("uniIm",this.wHeight)},async onLoad(t){let{token:i,user_id:o,conversation_id:n,joinGroup:a}=t,m="2023-05-22-01",p=s("uni-im-storage-version");p&&p!=m&&(r("uni-im-storage-version",m),c());let{tokenExpired:f}=e.getCurrentUserInfo();if(!f||f<Date.now()){console.info("当前用户的登录状态无效，将自动跳转至登录页面。",t);let e="/uni_modules/uni-id-pages/pages/login/login-withpwd?uniIdRedirectUrl=",i="/uni_modules/uni-im/pages/index/index?";for(let o in t)i+=`${o}=${t[o]}&`;return i=i.substring(0,i.length-1),e+=encodeURIComponent(i),l({url:e})}if(this.$nextTick((()=>{this.init({user_id:o,conversation_id:n})})),this.onLoginSuccess=async()=>{this.init({user_id:o,conversation_id:n})},u("uni-id-pages-login-success",this.onLoginSuccess),u("uni-im-toChat",(e=>{e&&(ae=!1,this.toChat(e)),this.showContactsView=!1})),a){let e=a;history.pushState({},"","/#/"),console.log("group_id",e),ne.collection("uni-im-group-join").add({group_id:e,message:""}).then((e=>{console.log("res: ",e),d({icon:"none",title:"已申请"})})).catch((e=>{h({content:e.message||"请求服务失败",showCancel:!1})}))}},async onReady(){let e=a();if(t.systemInfo=e,!["edge","chrome","safari"].includes(e.browserName)){let e=document.createElement("div");e.innerHTML='\n\t\t\t\t<div style="background: #fff9ea;color: #ff9a43;position: fixed;top: 0;left: 0;width: 100vw;padding: 15px;font-size: 18px;">\n\t\t\t\t\t注意：本系统仅兼容chrome、edge、safari浏览器\n\t\t\t\t</div>\n\t\t\t\t',document.body.appendChild(e)}},onUnload(){m("uni-id-pages-login-success",this.onLoginSuccess)},onHide(){},methods:{clickSearchBarBox(){d({title:"暂不支持",icon:"none"})},loadMore:async()=>await t.conversation.loadMore(),clickMenu(e){this.dynamicComponentName=e.componentName,e.title&&(this.view2Title=e.title),e.param&&this.$nextTick((()=>{this.$refs.dynamicComponent.setParam(e.param)})),"uni-im-createGroup"==e.componentName&&this.$nextTick((()=>{this.$refs.dynamicComponent.getFriendsData()}))},readQrCode(){p({complete:e=>{try{let t=JSON.parse(e.result);"uni-im"==t.type&&t.subType}catch(t){}}})},async init({conversation_id:e,user_id:i}){if(await this.loadMore(),e)this.toChat(e);else if(i){const e=await t.conversation.get({friend_uid:i});this.toChat(e.id)}else if(this.isWidescreen){let[e]=this.conversationList;e&&(this.currentConversation=await t.conversation.get(e.id),this.toChat(e.id))}},search(e){d({title:"加好友功能入口，暂时在左侧菜单的通讯录中",icon:"none",duration:3e3})},addUser(){d({title:"加好友功能入口，暂时在左侧菜单的通讯录中",icon:"none",duration:3e3})},async toChat(e){this.chatInfoIsShow=!1;let i="";if("string"==typeof e)i=e;else if(e.conversation_id)i=e.conversation_id;else if(e.group_id)i="group_"+e.group_id;else{if(!e.user_id&&!e.friend_uid)throw new Error("toChat param is error");i=f.getConversationId(e.user_id||e.friend_uid)}t.currentConversationId=i,this.isWidescreen?this.$nextTick((()=>{let e=this.$refs["chat-view"];e&&e.load(i)})):g({url:"/uni_modules/uni-im/pages/chat/chat?conversation_id="+i,animationDuration:300})},showChatInfo(){this.chatInfoIsShow=!this.chatInfoIsShow},toUcenter(){g({url:"/uni_modules/uni-id-pages/pages/userinfo/userinfo?showLoginManage=true",complete(e){console.log("e: "+JSON.stringify(e))}})},friendlyTime:e=>f.toFriendlyTime(e)},async onReachBottom(){await this.loadMore()},onNavigationBarButtonTap(e){if(e.index){_().keys.forEach((e=>{(e.includes("uni-im-msg:")||e.includes("uni-im-conversation"))&&C(e)})),d({title:"clear storage ok",icon:"none"})}else g({url:"/uni_modules/uni-id-pages/pages/userinfo/userinfo?showLoginManage=true",complete:e=>{console.log(e)}})}},[["render",function(e,t,i,o,n,a){const s=W,r=M,c=H($("cloud-image"),E),l=H($("uni-icons"),G),u=H($("uni-badge"),P),d=H($("uni-search-bar"),X),h=N("uni-im-contacts"),m=H($("uni-list-chat"),Y),p=H($("uni-load-more"),Z),f=H($("uni-list-item"),D),g=H($("uni-list"),ee),_=z,C=N("chat-view"),F=N("uni-im-group-info"),J=N("uni-im-chat-info"),O=H($("tabbar"),te);return v(),w(b,null,[y(r,{id:"page"},{default:k((()=>[e.isWidescreen?(v(),x(r,{key:0,id:"about",space:"nbsp"},{default:k((()=>[y(s,null,{default:k((()=>[T("欢迎体验im ​")])),_:1})])),_:1})):I("",!0),e.isWidescreen?(v(),x(r,{key:1,id:"left-view",onClick:t[2]||(t[2]=e=>{n.chatInfoIsShow=!1})},{default:k((()=>[y(c,{class:"user-avatar",onClick:a.toUcenter,src:a.avatarUrl,width:"40px",height:"40px",borderRadius:"100px"},null,8,["onClick","src"]),y(u,{size:"small",text:a.unreadMsgCount,absolute:"rightTop",type:"error"},{default:k((()=>[y(l,{class:"chat-icon",onClick:t[0]||(t[0]=e=>n.showContactsView=!1),color:n.showContactsView?"#c5c5c5":"#5fc08e",size:"32",type:"chatbubble-filled"},null,8,["color"])])),_:1},8,["text"]),y(u,{size:"small",text:a.unreadnotificationCount,absolute:"rightTop",type:"error"},{default:k((()=>[y(l,{onClick:t[1]||(t[1]=e=>n.showContactsView=!0),color:n.showContactsView?"#5fc08e":"#c5c5c5",size:"32",type:"staff-filled"},null,8,["color"])])),_:1},8,["text"])])),_:1})):I("",!0),y(r,{id:"center-view"},{default:k((()=>[e.isWidescreen?(v(),x(r,{key:0,id:"search-bar-box",onClick:a.clickSearchBarBox},{default:k((()=>[y(d,{readonly:!0,id:"search-bar",radius:"5",placeholder:"搜索",clearButton:"auto",cancelButton:"none"}),y(l,{color:"#848386",size:"26",type:"plus"})])),_:1},8,["onClick"])):I("",!0),j(y(r,{id:"uni-im-contacts-box"},{default:k((()=>[y(h,{onClickMenu:a.clickMenu,id:"uni-im-contacts"},null,8,["onClickMenu"])])),_:1},512),[[S,e.isWidescreen&&n.showContactsView]]),y(_,{id:"user-list-box","scroll-y":"true",onScrolltolower:t[3]||(t[3]=e=>a.loadMore())},{default:k((()=>[y(g,{class:"user-list",style:L({height:n.wHeight,width:"750rpx"}),border:!1},{default:k((()=>[(v(!0),w(b,null,U(a.conversationList,((t,i)=>(v(),x(m,{onContextmenu:B((e=>a.toChat(t.id)),["prevent"]),key:t.id,showBadge:t.unread_count>0,badgeText:t.unread_count,link:"",title:t.title,class:R(["user-list-item",{activeConversation:e.currentConversationId==t.id}]),note:t.last_msg_note,avatar:t.avatar_file&&t.avatar_file.url?t.avatar_file.url:"/uni_modules/uni-im/static/avatarUrl.png",onClick:e=>a.toChat(t.id),direction:"column",time:a.friendlyTime(t.update_time),hasCallMe:t.call_list.length},{header:k((()=>[t.group_id?(v(),x(s,{key:0,class:"group-icon"},{default:k((()=>[T("群")])),_:1})):I("",!0)])),_:2},1032,["onContextmenu","showBadge","badgeText","title","class","note","avatar","onClick","time","hasCallMe"])))),128)),y(f,{customStyle:{backgroundColor:"#f5f5f5",padding:0}},{body:k((()=>[y(p,{class:"tip",contentText:a.loadMoreContentText,status:a.conversationHasMore?"loading":"noMore"},null,8,["contentText","status"])])),_:1})])),_:1},8,["style"])])),_:1})])),_:1}),e.isWidescreen?(v(),x(r,{key:2,id:"right-view"},{default:k((()=>[y(r,{id:"chat-view-box"},{default:k((()=>[!n.showContactsView&&e.currentConversationId?(v(),w(b,{key:0},[n.showContactsView?I("",!0):(v(),x(r,{key:0,id:"chat-header"},{default:k((()=>[y(s,{selectable:!0},{default:k((()=>[T(V(n.currentConversation.title),1)])),_:1}),y(l,{onClick:a.showChatInfo,class:"more",type:"more-filled",size:"20"},null,8,["onClick"])])),_:1})),y(r,{id:"chat-view"},{default:k((()=>[y(C,{ref:"chat-view"},null,512)])),_:1}),n.chatInfoIsShow?(v(),x(r,{key:1,class:"chatInfoBox",onClick:t[6]||(t[6]=B((e=>n.chatInfoIsShow=!1),["stop"]))},{default:k((()=>[n.currentConversation.group_id?(v(),x(F,{key:0,onClick:t[4]||(t[4]=B((()=>{}),["stop"])),conversation_id:n.currentConversation.id},null,8,["conversation_id"])):(v(),x(J,{key:1,onClick:t[5]||(t[5]=B((()=>{}),["stop"])),conversation_id:n.currentConversation.id},null,8,["conversation_id"]))])),_:1})):I("",!0)],64)):(v(),x(r,{key:1,id:"ccid-is-null-tip"},{default:k((()=>[T(" 未选择会话对象 ")])),_:1}))])),_:1}),j(y(r,{id:"dynamic-component-box"},{default:k((()=>[y(r,{class:"dynamic-component-title"},{default:k((()=>[T(V(n.view2Title),1)])),_:1}),(v(),x($(n.dynamicComponentName),{ref:"dynamicComponent"},null,512))])),_:1},512),[[S,n.showContactsView]])])),_:1})):I("",!0)])),_:1}),e.isWidescreen?I("",!0):(v(),x(r,{key:0,id:"bottom-view"},{default:k((()=>[y(O)])),_:1}))],64)}],["__scopeId","data-v-8d1ec71a"]]);export{re as default};
