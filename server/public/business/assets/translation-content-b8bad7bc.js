var U=Object.defineProperty;var W=(g,a,e)=>a in g?U(g,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):g[a]=e;var y=(g,a,e)=>(W(g,typeof a!="symbol"?a+"":a,e),e);import"./adapter-vue-20243c9c.js";import{q as B,X as V,B as M,z as I,W as P,b as _,_ as A}from"./@tencentcloud-25a17c42.js";import{d as z,r as f,w as F,b2 as x,o as d,c as m,aV as u,a9 as b,F as w,aj as $,aw as k,E as q,u as H,a as j,ab as O}from"./@vue-25170201.js";import"./tim-upload-plugin-5e9dfffb.js";import"./tim-profanity-filter-plugin-23d0f338.js";import"./vue-04189d9a.js";import"./marked-7f3c3653.js";import"./trtc-cloud-js-sdk-ca6139e0.js";import"./trtc-sdk-v5-8c3e4b7a.js";import"./pinia-1182f1fa.js";import"./mitt-f7ef348c.js";import"./interactjs-c534f49a.js";import"./rtc-detect-1f468b1b.js";const v=class v{constructor(){y(this,"isUseCache",!0);y(this,"translationCache",new Map)}static getInstance(){return v.instance||(v.instance=new v),v.instance}async get(a){if(this.isUseCache){const s=this.translationCache.get(a.ID);if(s!==void 0)return s}const e=B.getMessageModel(a.ID);if(!e)return[];const{text:n}=e.getMessageContent()||{},t=[],l=await this.getNickList(e);for(let s=0;s<n.length;++s){const h=n[s];if(h.name==="img"){t.push({type:"face",value:h.src});continue}const{transSplitingList:C,atNickList:p}=this.getSplitResult(h.text,l);for(let r=0;r<C.length;++r)t.push({type:"text",value:C[r]}),r<p.length&&t.push({type:"mention",value:p[r]})}const i=[],o=t.filter((s,h)=>s.type==="text"&&s.value.trim()!==""?(i.push(h),!0):!1).map(s=>s.value);return o.length===0?(this.translationCache.set(e.ID,t),t):((await this.getTranslationStandard(o)).forEach((s,h)=>{t[i[h]].value=s}),this.translationCache.set(e.ID,t),t)}clear(){this.translationCache.clear()}disableCache(){this.isUseCache=!1}enableCache(){this.isUseCache=!0}getTranslationStandard(a){return new Promise((e,n)=>{V.translateText({sourceTextList:a,sourceLanguage:"auto"}).then(t=>{const{data:{translatedTextList:l}}=t;e(l)}).catch(t=>{n(t)})})}async getNickList(a){const e=[],{atUserList:n=[]}=a,t=M.TYPES.MSG_AT_ALL;if(n.includes(t)&&e.push(`@${I.t("TUIChat.所有人")}`),n.length>0){const{data:l}=await P.getUserProfile({userIDList:n});l.forEach(i=>{const o=`@${i.nick||i.userID}`;e.push(o)})}return[...new Set(e)]}getSplitResult(a,e){let n=0;const t=[],l=[];for(;n<a.length;){const i=a.indexOf("@",n);if(i===-1){t.push(a.substring(n));break}let o=!1;for(let c=0;c<e.length;++c){const s=a.indexOf(e[c],i);if(s!==-1&&s===i){t.push(a.substring(n,s)),l.push(e[c]),n=s+e[c].length,o=!0;break}}if(!o){t.push(a.substring(n));break}}return{transSplitingList:t,atNickList:l}}};y(v,"instance");let T=v;const X=T.getInstance(),G=["src"],Y={key:1,class:"text-plain"},J=z({__name:"translation-content",props:{message:{default:()=>({})},translationContentVisible:{type:Boolean},isSingleTranslation:{type:Boolean},translationWrapperRef:{}},emits:["toggleErrorStatus"],setup(g,{emit:a}){const e=a,n=g,t=f(!1),l=f(""),i=f([]),o=f(0),c=f(0),s=f(),h=f();return F(()=>n.translationContentVisible,C=>{C&&X.get(n.message).then(p=>{t.value=!0,i.value=p,x(()=>{const{height:r,width:L}=_(s.value),{height:S,width:R}=_(h.value);o.value=r,c.value=L,requestAnimationFrame(()=>{o.value=S,c.value=R,n.isSingleTranslation&&x(()=>{const{bottom:D}=_(n.translationWrapperRef),{bottom:E}=_("#messageScrollList");if(D>E){const N=setTimeout(()=>{n.translationWrapperRef.scrollIntoView({block:"end",behavior:"smooth"}),clearTimeout(N)},150)}})})})}).catch(p=>{t.value=!0;const{height:r}=_(s.value);o.value=r,i.value=[],e("toggleErrorStatus",!0),l.value=p.message})},{immediate:!0}),(C,p)=>(d(),m("div",{class:"message-translation-container",style:O({height:u(o)>0?`${u(o)}px`:"auto",width:u(c)>0?`${u(c)}px`:"auto"})},[u(t)?(d(),m("div",{key:0,ref_key:"translationContentRef",ref:h,class:b({"translation-content":!0,occur:u(o)>0})},[u(i).length>0?(d(!0),m(w,{key:0},$(u(i),(r,L)=>(d(),m("span",{key:L},[r.type==="face"?(d(),m("img",{key:0,class:"text-face",src:r.value},null,8,G)):(d(),m("span",Y,k(r.value),1))]))),128)):(d(),m(w,{key:1},[q(k(u(l)),1)],64))],2)):H("",!0),j("div",{ref_key:"translationLoadingRef",ref:s,class:b({loading:!0,"loading-end":u(t)})},k(u(I).t("TUIChat.翻译中"))+"... ",3)],4))}});const ht=A(J,[["__scopeId","data-v-ca204013"]]);export{ht as default};
