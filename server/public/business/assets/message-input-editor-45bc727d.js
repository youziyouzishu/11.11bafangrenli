var Kt=Object.defineProperty;var Wt=(a,n,c)=>n in a?Kt(a,n,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[n]=c;var W=(a,n,c)=>(Wt(a,typeof n!="symbol"?n+"":n,c),c);import{d as zt,bl as Jt,r as O,aU as $t,aW as Gt,w as Qt,o as z,c as J,aw as Yt,u as vt,aV as xt,aP as qt,a9 as Xt}from"./@vue-25170201.js";import"./adapter-vue-20243c9c.js";import{B as Zt,q as w,o as S,i as x,J as Ct,z as $,_ as jt}from"./@tencentcloud-25a17c42.js";import{I as wt,E as te,D as ee,P as ne,T as ae,a as se,M as re}from"./@tiptap-008a465d.js";import{i as p,a as b}from"./env-6b0ecdb8.js";import{t as ie,p as le}from"./index-8f711959.js";import{J as oe}from"./type-check-5e73d261.js";import"./tim-upload-plugin-5e9dfffb.js";import"./tim-profanity-filter-plugin-23d0f338.js";import"./vue-04189d9a.js";import"./marked-7f3c3653.js";import"./trtc-cloud-js-sdk-ca6139e0.js";import"./trtc-sdk-v5-8c3e4b7a.js";import"./pinia-1182f1fa.js";import"./mitt-f7ef348c.js";import"./interactjs-c534f49a.js";import"./rtc-detect-1f468b1b.js";import"./prosemirror-state-c544e594.js";import"./prosemirror-model-8b0495eb.js";import"./orderedmap-1b52af60.js";import"./prosemirror-transform-fc1f2a72.js";import"./prosemirror-view-ef3f9f96.js";import"./prosemirror-keymap-776f822d.js";import"./w3c-keyname-a25e4cc1.js";import"./prosemirror-commands-5c2a1a07.js";import"./prosemirror-schema-list-1c96ec4d.js";import"./index-7638d9aa.js";import"./element-plus-64da2267.js";import"./lodash-es-fbce1780.js";import"./async-validator-dee29e8b.js";import"./@element-plus-9559a6ac.js";import"./dayjs-346d7cd4.js";import"./@ctrl-f8748455.js";import"./@popperjs-c75af06c.js";import"./normalize-wheel-es-ed76fb12.js";import"./@vueuse-944ef3f4.js";import"./lodash-2cc29f39.js";import"./axios-67477f72.js";import"./vue-router-f7517f62.js";import"./css-color-function-7acc3e97.js";import"./color-9254db0b.js";import"./clone-db6b0f3b.js";import"./color-convert-946e453a.js";import"./color-name-b7949e8c.js";import"./color-string-6fa48439.js";import"./balanced-match-51764fed.js";import"./ms-f6814399.js";import"./nprogress-ccaead9e.js";import"./vue-clipboard3-f5f9feb9.js";import"./clipboard-3d849c41.js";import"./echarts-d6620a89.js";import"./zrender-9797a04d.js";import"./tslib-54e39b60.js";import"./highlight.js-1b502259.js";import"./@highlightjs-7a15facb.js";import"./path-to-regexp-767716ea.js";import"./constant-bad60a54.js";const ce=wt.extend({name:"custom-image",addAttributes(){return{...wt.config.addAttributes(),class:{default:"image",rendered:!1}}},addCommands(){return{setImage:a=>({tr:n,commands:c})=>{var g,m,y;return((y=(m=(g=n.selection)==null?void 0:g.node)==null?void 0:m.type)==null?void 0:y.name)=="custom-image"?c.updateAttributes("custom-image",a):c.insertContent({type:this.name,attrs:a})}}},renderHTML({node:a,HTMLAttributes:n}){var c;return n.class=((c=a.attrs.class)!=null&&c.includes("custom-image-")?"":"custom-image-")+a.attrs.class,["img",n]}});let D="",Q=[],C=[],f=[],L=0,A=!1,Y;const ue={userID:Zt.TYPES.MSG_AT_ALL,nick:"所有人",isAll:!0,avatar:"https://web.sdk.qcloud.com/im/assets/images/at.svg"};w.watch(S.CONV,{currentConversationID:a=>{a!==D&&(D=a,D!=null&&D.startsWith("GROUP")?A=!0:(A=!1,Q=[],C=[],f=[]))}});w.watch(S.CUSTOM,{memberList:a=>{A&&Array.isArray(a)&&(Q=a,C=[ue,...Q],f=C)}});const fe=()=>({allowedPrefixes:null,items:a=>{if(!A)return;const n=C==null?void 0:C.filter(c=>{var g,m,y,k,P,E;return((y=(g=c==null?void 0:c.nick)==null?void 0:g.toLowerCase())==null?void 0:y.startsWith((m=a==null?void 0:a.query)==null?void 0:m.toLowerCase()))||((E=(k=c==null?void 0:c.userID)==null?void 0:k.toLowerCase())==null?void 0:E.startsWith((P=a==null?void 0:a.query)==null?void 0:P.toLowerCase()))});return f=n!=null&&n.length?n:C,x.setShowMemberList(f),f},render:()=>({onStart:a=>{if(!A||(x.toggleAtList(!0),!(a!=null&&a.clientRect)))return;const n=a==null?void 0:a.clientRect();n!=null&&n.left&&(n!=null&&n.top)&&!p&&x.handleAtListPosition({left:n==null?void 0:n.left,top:n==null?void 0:n.top}),Y=a.command},onUpdate(a){if(!A||!(a!=null&&a.clientRect))return;const n=a==null?void 0:a.clientRect();n!=null&&n.left&&(n!=null&&n.top)&&!p&&x.handleAtListPosition({left:n==null?void 0:n.left,top:n==null?void 0:n.top})},onKeyDown(a){var n,c;if(A)return a.event.key==="Enter"&&((n=a.event)==null||n.stopPropagation(),(c=a.event)==null||c.preventDefault()),a.event.key==="Escape"?(x.toggleAtList(!1),f=C,!0):(a==null?void 0:a.event.key)==="ArrowUp"?(me(),!0):(a==null?void 0:a.event.key)==="ArrowDown"?(de(),!0):(a==null?void 0:a.event.key)==="Enter"?(ge(),!0):!1},onExit(){A&&(x.toggleAtList(!1),f=C,x.handleAtListPosition({left:0,top:0}))}})}),me=()=>{f!=null&&f.length&&(L=(L+(f==null?void 0:f.length)-1)%(f==null?void 0:f.length),x.setCurrentSelectIndex(L))},de=()=>{f!=null&&f.length&&(L=(L+1)%(f==null?void 0:f.length),x.setCurrentSelectIndex(L))},ge=()=>{Et(L)},Et=a=>{if(!(f!=null&&f.length))return;const n=f[a];n&&Y&&Y({id:n==null?void 0:n.userID,label:(n==null?void 0:n.nick)||(n==null?void 0:n.userID)})};x.selectItem=Et;const pe=fe,_=class _{constructor(){W(this,"quoteMessageMap",new Map)}static getInstance(){return _.instance||(_.instance=new _),_.instance}setStore(n,c,g,m){var y,k;if(n&&(this.isEditorNotEmpty(c)||(y=m==null?void 0:m.message)!=null&&y.ID)){let P={};(k=m==null?void 0:m.message)!=null&&k.ID&&(this.quoteMessageMap.set(m.message.ID,m.message),P={messageID:m.message.ID,type:m.type});const E={conversationID:n,draftInfo:{html:c,abstract:g,...P}};Ct.setConversationDraft(E),w.update(S.CHAT,"quoteMessage",{message:void 0,type:"quote"})}}getStore(n,c){const g=w.getConversationModel(n);if(g){if(g.conversationID&&g.draftText){const m=oe(g.draftText);w.update(S.CHAT,"quoteMessage",{message:this.quoteMessageMap.get(m.messageID)||void 0,type:m.type}),c(m.html)}Ct.setConversationDraft({conversationID:g.conversationID})}}generateAbstract(n){let c="";return n==null||n.forEach(g=>{switch(g.type){case"text":c+=ie(g.payload.text||"");break;case"image":c+=$.t("TUIChat.图片");break;case"video":c+=$.t("TUIChat.视频");break;case"file":c+=$.t("TUIChat.文件");break}}),c}isEditorNotEmpty(n){return n&&!n.includes("is-empty")&&n!=="<p></p>"}};W(_,"instance",null);let q=_;const G=q.getInstance(),he={key:0,class:"message-input-mute"},ye=["contenteditable"],ve=zt({__name:"message-input-editor",props:{placeholder:{type:String,default:"this is placeholder"},replayOrReferenceMessage:{type:Object,default:()=>({})},isMuted:{type:Boolean,default:!0},muteText:{type:String,default:""},enableInput:{type:Boolean,default:!0},enableAt:{type:Boolean,default:!0},enableDragUpload:{type:Boolean,default:!0},enableTyping:{type:Boolean,default:!0}},emits:["sendMessage","onTyping","onAt"],setup(a,{expose:n,emit:c}){const g=a,m=c,{placeholder:y,enableAt:k,enableDragUpload:P,enableTyping:E}=Jt(g),N=O(!0),T=O(!0),M=O(!1),F=O(""),X=O(),h=O();let o=null;const I=new Map;function Z(t){F.value!==t&&(F.value&&G.setStore(F.value,rt(),G.generateAbstract(et()),X.value),st(),t&&G.getStore(t,it)),F.value=t}function j(t){X.value=t}$t(()=>{o=b?new te({element:h.value,extensions:[ee,ne,ae,se.configure({emptyEditorClass:"is-editor-empty",placeholder:y.value}),re.configure({HTMLAttributes:{class:"mention"},suggestion:k.value&&pe()}),ce.configure({inline:!0,allowBase64:!0})],autofocus:!p,editable:!0,injectCSS:!1,editorProps:{transformPastedText(){return""}},onUpdate({editor:t,transaction:e}){var s,r;!E.value||!M.value||(T.value=!t.isFocused,((r=(s=e==null?void 0:e.doc)==null?void 0:s.content)==null?void 0:r.size)>2?N.value=!1:N.value=!0)},onFocus(){var t;if(p&&((t=document==null?void 0:document.getElementById("app"))!=null&&t.style)){const e=document.body.scrollHeight-window.innerHeight;document.getElementById("app").style.marginBottom=`${e}px`,document.getElementById("app").style.height=`calc(100% - ${e}px)`}!E.value||!M.value||(T.value=!0)},onBlur(){var t;p&&((t=document==null?void 0:document.getElementById("app"))!=null&&t.style)&&(document.getElementById("app").style.marginBottom="",document.getElementById("app").style.height="100%"),!(!E.value||!M.value)&&(T.value=!0)}}):null,w.watch(S.CONV,{currentConversationID:Z}),w.watch(S.CHAT,{quoteMessage:j})}),Gt(()=>{w.unwatch(S.CONV,{currentConversationID:Z}),w.unwatch(S.CHAT,{quoteMessage:j}),I.clear()});function Tt(t){var e;p||(t==null||t.preventDefault(),t==null||t.stopPropagation(),t.keyCode===13&&t.ctrlKey?(e=o==null?void 0:o.commands)==null||e.insertContent("<p></p>"):t.keyCode===13&&m("sendMessage"))}function It(t){var e;p&&(t.data==="@"&&m("onAt",!0),N.value=!((e=h.value)!=null&&e.childNodes))}function bt(){p&&(T.value=!0)}function At(){p&&(T.value=!1)}function St(t){var s;const e=document.createElement("span");e.innerHTML=t.label,e.className="mention",e.id=t.id,(s=h.value)==null||s.appendChild(e)}function kt(t){b&&tt(t,"drop")}function Pt(t){t.clipboardData&&(b&&t.clipboardData.files.length?tt(t,"paste"):(Bt(t),Vt(h.value)))}function Bt(t){var r,l;t.preventDefault();const e=(r=t.clipboardData)==null?void 0:r.getData("text/html"),s=((l=t.clipboardData)==null?void 0:l.getData("text/plain"))||"";if(!e){const u=le(s);lt(u)}}async function tt(t,e){var s,r,l;if(t.preventDefault(),t.stopPropagation(),!(!P.value&&e==="drop")&&(e==="drop"&&t.dataTransfer||e==="paste"&&t.clipboardData)){const u=e==="drop"?(s=t==null?void 0:t.dataTransfer)==null?void 0:s.files:(r=t==null?void 0:t.clipboardData)==null?void 0:r.files;for(let i=0;i<u.length;i++){const d=u[i],B=d.type.startsWith("image/"),U=B?URL.createObjectURL(d):await Rt(d);(l=o==null?void 0:o.commands)==null||l.insertContent({type:"custom-image",attrs:{src:U,alt:d==null?void 0:d.name,class:B?"normal":"file"}}),I.set(U,d),i===u.length-1&&setTimeout(()=>{var R,H;(R=o==null?void 0:o.commands)==null||R.focus("end"),(H=o==null?void 0:o.commands)==null||H.scrollIntoView()},10)}}}const V=new Map,Ut=(t,e)=>new Promise((s,r)=>{if(V.has(e))s(V.get(e));else{const l=new Image;l.crossOrigin="anonymous",l.onload=()=>{V.set(e,l),s(l)},l.onerror=r,l.src=t}}),Rt=async t=>{const{name:e,type:s}=t,r=document.createElement("canvas"),l=160,u=50;r.style.width=l+"px",r.style.height=u+"px";const i=window.devicePixelRatio;r.width=Math.floor(l*i),r.height=Math.floor(u*i);const d=r.getContext("2d");if(!d)return"";d.scale(i,i);const{iconSrc:B,iconType:U}=Ht(s),R=await Ut(B,U);d==null||d.drawImage(R,10,10,30,30);const H=_t(e);return d.fillText(H,45,22),r.toDataURL()},Ht=t=>{const e="https://web.sdk.qcloud.com/component/TUIKit/assets/file-",s=["image","pdf","text","ppt","presentation","sheet","zip","word","video","unknown"];let r="",l="";return s.forEach(u=>{t.includes(u)&&(r=e+u+".svg",l=u)}),{iconSrc:r||e+"unknown.svg",iconType:l||"unknown"}},_t=t=>{if(!t)return t;let e="",s=0;for(let r=0;r<(t==null?void 0:t.length);r++){if(s>16){e+="...";break}e+=t[r],/[a-z]|[0-9]|[,;.!@#-+/\\$%^*()<>?:"'{}~]/i.test(t[r])?s+=1:s+=2}return e};function et(){return b?Lt():Nt()}function Lt(){var s,r;const t=o==null?void 0:o.getJSON(),e=[];if(nt(t,e),e.length>0&&e[e.length-1]&&e[e.length-1].type==="text"&&((r=(s=e[e.length-1].payload)==null?void 0:s.text)!=null&&r.endsWith(`
`))){const l=e[e.length-1].payload.text||"";e[e.length-1].payload.text=l==null?void 0:l.substring(0,l.lastIndexOf(`
`))}return e}function nt(t,e){var s;if(!(!t||!t.type))if(t.type!=="text"&&t.type!=="custom-image"&&t.type!=="mention"){t.type==="paragraph"&&at(t,e),(s=t.content)!=null&&s.length&&t.content.forEach(r=>{nt(r,e)});return}else at(t,e)}function at(t,e){var s,r,l,u,i,d,B,U,R,H,K,ot,ct,ut,ft,mt,dt,gt,pt,ht,yt;if(t.type==="paragraph")e.length>0&&e[e.length-1]&&((s=e[e.length-1])==null?void 0:s.type)==="text"&&(e[e.length-1].payload.text+=`
`);else if(t.type==="text"||t.type==="custom-image"&&((l=(r=t==null?void 0:t.attrs)==null?void 0:r.class)!=null&&l.includes("emoji"))){const v=t.type==="text"?t==null?void 0:t.text:(u=t==null?void 0:t.attrs)==null?void 0:u.alt;e.length>0&&e[e.length-1]&&((i=e[e.length-1])==null?void 0:i.type)==="text"?e[e.length-1].payload.text+=v:e.push({type:"text",payload:{text:v}})}else if(t.type==="custom-image"&&((B=(d=t==null?void 0:t.attrs)==null?void 0:d.class)!=null&&B.includes("normal")))e.push({type:"image",payload:{file:I==null?void 0:I.get((U=t==null?void 0:t.attrs)==null?void 0:U.src)}});else if(t.type==="custom-image"&&((H=(R=t==null?void 0:t.attrs)==null?void 0:R.class)!=null&&H.includes("file"))){const v=I==null?void 0:I.get((K=t==null?void 0:t.attrs)==null?void 0:K.src);e.push({type:(ot=v==null?void 0:v.type)!=null&&ot.includes("video")?"video":"file",payload:{file:v}})}else if(t.type==="mention"){const v="@"+((ct=t==null?void 0:t.attrs)==null?void 0:ct.label)+" ";e.length>0&&e[e.length-1]&&((ut=e[e.length-1])==null?void 0:ut.type)==="text"?e[e.length-1].payload.text+=v:e.push({type:"text",payload:{text:v}}),(mt=(ft=e[e.length-1])==null?void 0:ft.payload)!=null&&mt.atUserList?(ht=(gt=(dt=e[e.length-1])==null?void 0:dt.payload)==null?void 0:gt.atUserList)==null||ht.push((pt=t==null?void 0:t.attrs)==null?void 0:pt.id):e[e.length-1].payload.atUserList=[(yt=t==null?void 0:t.attrs)==null?void 0:yt.id]}}function Nt(){var r,l,u;const t=h.value;let e="";const s=[];try{for(const i of t.childNodes)(i.nodeName==="#text"||i.nodeName==="SPAN"||(r=i.classList)!=null&&r.contains("custom-image-emoji")||(l=i.classList)!=null&&l.contains("mention"))&&(e+=i.nodeValue||i.alt||i.innerHTML||"",(u=i.classList)!=null&&u.contains("mention")&&i.id&&!(s!=null&&s.includes(i.id))&&s.push(i.id))}catch(i){if(i instanceof Error)throw i}return[{type:"text",payload:{text:e,atUserList:s}}]}function Ot(t){var e,s,r,l,u;if(b)(e=o==null?void 0:o.commands)==null||e.insertContent({type:"custom-image",attrs:{src:t==null?void 0:t.url,alt:t==null?void 0:t.emoji.key,title:t==null?void 0:t.emoji.key,class:"emoji"}});else{const i=document.createElement("img");i==null||i.setAttribute("src",t==null?void 0:t.url),i==null||i.setAttribute("class","custom-image custom-image-emoji"),i==null||i.setAttribute("alt",t==null?void 0:t.emoji.key),i==null||i.setAttribute("title",t==null?void 0:t.emoji.key),i==null||i.setAttribute("width","20px"),i==null||i.setAttribute("height","20px"),(s=h.value)==null||s.appendChild(i);const d=document.createElement("span");d.contentEditable="true",(r=h.value)==null||r.appendChild(d)}p||((l=o==null?void 0:o.commands)==null||l.focus(),(u=o==null?void 0:o.commands)==null||u.scrollIntoView())}function Dt(){var t,e;b?(t=o==null?void 0:o.commands)==null||t.blur():(e=h.value)==null||e.blur()}function st(){var t;(t=o==null?void 0:o.commands)==null||t.clearContent(!0),T.value=!0,N.value=!0,p&&(h.value.innerHTML="")}function rt(){return b?o==null?void 0:o.getHTML():h.value.innerHTML}function it(t){var e;b?(e=o==null?void 0:o.commands)==null||e.setContent(t):h.value.innerHTML=t}function lt(t){const e=window.getSelection();if(e&&e.rangeCount){const s=e.getRangeAt(0);t.forEach(r=>{const l=r.type==="image"?Mt(r.emojiKey||"",r.content):Ft(r.content);if(s.insertNode(l),s.setStartAfter(l),r.type==="image"&&p){const u=document.createElement("span");u.contentEditable="true",s.insertNode(u),s.setStartAfter(u)}}),s.collapse(!1),e.removeAllRanges(),e.addRange(s)}}function Ft(t){return document.createTextNode(t)}function Mt(t,e){const s=document.createElement("img");return s.src=e,s.alt=t||"",s.classList.add("custom-image","custom-image-emoji"),s.width=20,s.height=20,s}function Vt(t){const e=window.getSelection();if(e&&e.rangeCount>0){const s=e.getRangeAt(0),r=document.createRange(),l="​",u=document.createTextNode(l);r.setStart(s.startContainer,s.startOffset),r.insertNode(u);const i=r.getBoundingClientRect();u.parentNode&&u.parentNode.removeChild(u),t.scrollTop=i.top-t.getBoundingClientRect().top}}return Qt(()=>[N.value,T.value],(t,e)=>{t!==e&&m("onTyping",N.value,T.value)},{immediate:!0,deep:!0}),n({getEditorContent:et,addEmoji:Ot,resetEditor:st,insertAt:St,setEditorContent:it,getEditorHTML:rt,insertEditorContent:lt,blur:Dt}),(t,e)=>(z(),J("div",{class:Xt(["message-input-editor-container",xt(p)&&"message-input-editor-container-h5"])},[a.isMuted?(z(),J("div",he,Yt(a.muteText),1)):vt("",!0),!a.isMuted&&a.enableInput?(z(),J("div",{key:1,ref_key:"editorDom",ref:h,class:"message-input-editor-area",contenteditable:xt(p),onKeydown:qt(Tt,["enter"]),onDrop:kt,onPaste:Pt,onInput:It,onBlur:bt,onFocus:At},null,40,ye)):vt("",!0)],2))}});const In=jt(ve,[["__scopeId","data-v-3818f330"]]);export{In as default};
