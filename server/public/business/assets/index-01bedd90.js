var tt=Object.defineProperty;var st=(_,u,v)=>u in _?tt(_,u,{enumerable:!0,configurable:!0,writable:!0,value:v}):_[u]=v;var Y=(_,u,v)=>(st(_,typeof u!="symbol"?u+"":u,v),v);import{d as ot,r as l,b as we,aU as _e,aW as at,b2 as Pe,w as nt,o as i,c as O,a as b,aV as o,aw as q,u as T,t as c,F as lt,aj as it,G,a9 as oe,aR as rt,aM as L}from"./@vue-25170201.js";import"./adapter-vue-20243c9c.js";import{i as Le,q as h,o as C,B as ut,R as ct,r as gt,X as Re,z as J,f as Oe,I as mt,P as pt,E as dt,_ as ft}from"./@tencentcloud-25a17c42.js";import{l as Mt}from"./lodash-2cc29f39.js";import ht from"./index-4cff07d5.js";import vt from"./message-text-4132c1d0.js";import It from"./message-image-131f5c5d.js";import St from"./message-audio-f41eece1.js";import{M as Tt}from"./index-e1b60aa5.js";import Ct from"./message-file-babfc691.js";import yt from"./message-face-0ee0d869.js";import Dt from"./message-custom-4c554336.js";import Et from"./message-tip-146bc814.js";import kt from"./message-bubble-c0cc7deb.js";import wt from"./message-location-9788ed03.js";import _t from"./message-timestamp-54812030.js";import Pt from"./message-video-1a9a22eb.js";import Lt from"./index-397470ed.js";import Rt from"./message-revoked-1c7ffc30.js";import{i as Ot,M as bt}from"./message-plugin-849aedd1.js";import Gt from"./index-514ca0db.js";import At from"./index-e656c675.js";import Bt from"./index-11528969.js";import Ht from"./index-bc2bb4c0.js";import ae from"./index-60212fd7.js";import{e as be}from"./index-8f711959.js";import{c as Ge,a as ne,i as Ae}from"./env-6b0ecdb8.js";import{i as Be,a as Ut,d as xt,s as Nt}from"./utils-601596c6.js";import"./tim-upload-plugin-5e9dfffb.js";import"./tim-profanity-filter-plugin-23d0f338.js";import"./vue-04189d9a.js";import"./marked-7f3c3653.js";import"./trtc-cloud-js-sdk-ca6139e0.js";import"./trtc-sdk-v5-8c3e4b7a.js";import"./pinia-1182f1fa.js";import"./mitt-f7ef348c.js";import"./interactjs-c534f49a.js";import"./rtc-detect-1f468b1b.js";import"./Icon-fec85db6.js";import"./index-15293322.js";import"./index-5255cd2a.js";import"./index-3a577aae.js";import"./close-dark-2378607d.js";import"./back-51a4f00d.js";import"./video-play-6934d780.js";import"./message-container-aeb74b8c.js";import"./files-37ebf78f.js";import"./type-check-5e73d261.js";import"./constant-bad60a54.js";import"./star-light-46b224d3.js";import"./index-ae164957.js";import"./config-58aee8b5.js";import"./index-e044d709.js";import"./index-ebb29dde.js";import"./index-9521edcb.js";import"./index-84a33251.js";import"./translation-content-b8bad7bc.js";import"./index-7208319e.js";import"./convert-content-4209ee90.js";import"./index-79e54707.js";import"./icon-close-aa3d72bb.js";import"./enableSampleTaskStatus-86998722.js";import"./message-plugin-layout-f8148c2d.js";import"./message-call-group-73eac480.js";import"./message-call-c2c-9034a137.js";import"./index-784fd949.js";import"./message-customer-service-49a2fb79.js";import"./message-room-default-d4932a61.js";import"./index-05c3d16c.js";import"./image-item.vue_vue_type_style_index_0_lang-8f2a780f.js";import"./index-7638d9aa.js";import"./element-plus-64da2267.js";import"./lodash-es-fbce1780.js";import"./async-validator-dee29e8b.js";import"./@element-plus-9559a6ac.js";import"./dayjs-346d7cd4.js";import"./@ctrl-f8748455.js";import"./@popperjs-c75af06c.js";import"./normalize-wheel-es-ed76fb12.js";import"./@vueuse-944ef3f4.js";import"./axios-67477f72.js";import"./vue-router-f7517f62.js";import"./css-color-function-7acc3e97.js";import"./color-9254db0b.js";import"./clone-db6b0f3b.js";import"./color-convert-946e453a.js";import"./color-name-b7949e8c.js";import"./color-string-6fa48439.js";import"./balanced-match-51764fed.js";import"./ms-f6814399.js";import"./nprogress-ccaead9e.js";import"./@tiptap-008a465d.js";import"./prosemirror-state-c544e594.js";import"./prosemirror-model-8b0495eb.js";import"./orderedmap-1b52af60.js";import"./prosemirror-transform-fc1f2a72.js";import"./prosemirror-view-ef3f9f96.js";import"./prosemirror-keymap-776f822d.js";import"./w3c-keyname-a25e4cc1.js";import"./prosemirror-commands-5c2a1a07.js";import"./prosemirror-schema-list-1c96ec4d.js";import"./vue-clipboard3-f5f9feb9.js";import"./clipboard-3d849c41.js";import"./echarts-d6620a89.js";import"./zrender-9797a04d.js";import"./tslib-54e39b60.js";import"./highlight.js-1b502259.js";import"./@highlightjs-7a15facb.js";import"./path-to-regexp-767716ea.js";const Ft={product:{label:"产品文档",url:"https://cloud.tencent.com/document/product/269/1499#.E7.BE.A4.E7.BB.84.E5.8A.9F.E8.83.BD"},customMessage:{label:"自定义消息",url:"https://web.sdk.qcloud.com/im/doc/zh-cn/SDK.html#createCustomMessage"},complaint:{label:"点此投诉",url:"https://cloud.tencent.com/apply/p/xc3oaubi98g"},implement:{label:"集成TUICallKit",url:"https://cloud.tencent.com/document/product/269/79861"},purchase:{label:"开通腾讯实时音视频服务",url:"https://cloud.tencent.com/document/product/1640/79968"}},jt=Ft,M=class M{constructor(){Y(this,"chatStorage",null)}static getInstance(){return M.instance||(M.instance=new M),M.instance}getChatStorage(u){if(this.chatStorage||(this.chatStorage=this.getChatStorageFromLocalStorage()),u)return this.chatStorage[u];throw new Error("No key provided")}setChatStorage(u,v){this.chatStorage||(this.chatStorage=this.getChatStorageFromLocalStorage()),this.chatStorage[u]=v;try{Ge?Le.setStorageSync(M.CHAT_STORAGE_KEY,JSON.stringify(this.chatStorage)):localStorage.setItem(M.CHAT_STORAGE_KEY,JSON.stringify(this.chatStorage))}catch{throw new Error("Fail to set chat storage")}}getChatStorageFromLocalStorage(){let u="";if(Ge?u=Le.getStorageSync(M.CHAT_STORAGE_KEY)||"":u=localStorage.getItem(M.CHAT_STORAGE_KEY)||"",!u)return{};try{this.chatStorage=JSON.parse(u)}catch{this.chatStorage={}}return this.chatStorage}};Y(M,"instance",null),Y(M,"CHAT_STORAGE_KEY","TUI_CHAT_STORAGE");let ie=M;const le=ie.getInstance(),Vt={key:0,class:"tui-chat-safe-tips"},Yt=["id"],qt={class:"message-item"},Jt=["onLongpress","onContextmenu","onTouchstart","onTouchend","onMouseover"],Kt={class:"delDialog-title"},$t=ot({__name:"index",props:{isGroup:{type:Boolean,default:!1},groupID:{default:""},isNotInGroup:{type:Boolean,default:!1},isMultipleSelectMode:{type:Boolean,default:!1}},emits:["closeInputToolBar","toggleMultipleSelectMode","handleEditor"],setup(_,{expose:u,emit:v}){const U=v,I=_;let K,m=null;const $=new Set,He=h.getData(C.APP,"isOfficial"),Ue=h.getData(C.APP,"enabledEmojiPlugin"),g=l(),X=l(),p=l(),xe=l(),E=l([]),re=l(!1),ue=l(""),z=l(),Ne=l(),A=l(""),d=l(ut.TYPES),W=l(!1),y=l(),Q=l(),ce=l(),P=l([]),Z=l(),ge=l(!1),ee=l(),x=l(0),me=l(!1),k=l({}),N=l(!1),F=l(),Fe=we(()=>{var t;return(t=p==null?void 0:p.value)==null?void 0:t.filter(s=>!s.isRevoked&&!s.hasRiskContent&&s.type===d.value.MSG_IMAGE)}),R=l(!1),pe=l(),de=we(()=>ct.getExtensionList(gt.TUIChat.EXTENSION.MSG_POP_MENU.EXT_ID,{enabledEmojiPlugin:Ue}).some(s=>s.text==="TUIEmojiPlugin"));_e(()=>{k.value=le.getChatStorage("audioPlayedMapping")||{},h.watch(C.CHAT,{messageList:fe,messageSource:Me,isCompleted:he}),h.watch(C.CONV,{currentConversationID:Ie}),h.watch(C.CUSTOM,{isShowMessagePopMenu:ve})}),_e(()=>{var t;(t=g.value)==null||t.addEventListener("scroll",ye)}),at(()=>{var t;h.unwatch(C.CHAT,{messageList:fe,messageSource:Me,isCompleted:he}),h.unwatch(C.CONV,{currentConversationID:Ie}),h.unwatch(C.CUSTOM,{isShowMessagePopMenu:ve}),(t=g.value)==null||t.removeEventListener("scroll",ye),Object.keys(k.value).length>0&&le.setChatStorage("audioPlayedMapping",k.value),$.clear(),m==null||m.disconnect(),m=null});async function fe(t){var n,f,D,S,w;m==null||m.disconnect();const s=z.value;let e=!1;if(xe.value=t,p.value=t.filter(r=>{var H;return(H=r.reactionList)!=null&&H.length&&!r.isDeleted&&(e=!0),!r.isDeleted}),!((n=p.value)!=null&&n.length)){z.value={};return}const a=(D=p.value)==null?void 0:D[((f=p.value)==null?void 0:f.length)-1];if(y.value){if(((S=p.value)==null?void 0:S.findIndex(r=>{var H;return(r==null?void 0:r.ID)===((H=y.value)==null?void 0:H.ID)}))>=0){const r=y.value;y.value=void 0,await B({scrollToMessage:r}),await V(r==null?void 0:r.ID)}}else if(x.value)await B({scrollToOffset:{bottom:x.value}}),x.value=0;else{if((w=Z.value)!=null&&w.isScrollButtonVisible&&(a==null?void 0:a.flow)==="in")return;a!=null&&a.ID&&JSON.stringify(s)!==JSON.stringify(a)?await B({scrollToBottom:!0}):e&&je()&&await B({scrollToBottom:!0})}z.value=Object.assign({},a),Be()&&Pe(()=>ze())}function je(){return g.value&&typeof g.value.scrollTop=="number"&&typeof g.value.scrollHeight=="number"&&typeof g.value.clientHeight=="number"&&Math.ceil(g.value.scrollTop+g.value.clientHeight)>=g.value.scrollHeight}async function B(t={}){return new Promise((s,e)=>{requestAnimationFrame(()=>{var n,f,D;g.value||e();const a=g.value;if(t.scrollToBottom)a.scrollTop=a.scrollHeight;else if(t.scrollToMessage){const S=(n=Q.value)==null?void 0:n.find(w=>{var r;return(w==null?void 0:w.id)===`tui-${(r=t.scrollToMessage)==null?void 0:r.ID}`});S!=null&&S.scrollIntoView&&S.scrollIntoView({behavior:"smooth",block:"nearest"})}else t.scrollToOffset&&((f=t.scrollToOffset)!=null&&f.top?a.scrollTop=t.scrollToOffset.top:(D=t.scrollToOffset)!=null&&D.bottom&&(a.scrollTop=a.scrollHeight-t.scrollToOffset.bottom));s()})})}async function Me(t){var s;if(y.value=t,y.value&&((s=p.value)==null?void 0:s.findIndex(e=>{var a;return(e==null?void 0:e.ID)===((a=y.value)==null?void 0:a.ID)}))>=0){const e=y.value;y.value=void 0,await B({scrollToMessage:e}),await V(e==null?void 0:e.ID)}}function he(t){re.value=t}function ve(t){t||(A.value="")}const Ie=t=>{if(ue.value=t,ue.value||(p.value=[]),Be()){const{groupProfile:s}=h.getConversationModel(t)||{};K=s==null?void 0:s.type}Object.keys(k.value).length>0&&le.setChatStorage("audioPlayedMapping",k.value)},Ve=()=>{var t;Re.getMessageList().then(s=>{const{nextReqMessageID:e}=s.data;Ne.value=e}),x.value=(t=g.value)==null?void 0:t.scrollHeight},Ye=t=>{window.open(t.url)},qe=t=>{N.value||F.value||W.value||(N.value=!0,F.value=t)},Je=()=>{N.value=!1,F.value=null},te=(t,s,e=!1)=>{I.isMultipleSelectMode||I.isNotInGroup||(e&&(W.value=!0),A.value=s.ID,Se(t.target))},Ke=(t,s)=>{var e;I.isMultipleSelectMode||I.isNotInGroup||ne&&(A.value=s.ID,ce.value=(e=Q.value)==null?void 0:e.find(a=>(a==null?void 0:a.id)===`tui-${s.ID}`),Pe(()=>{var n;const a=X.value&&((n=X.value[0])==null?void 0:n.messageToolDom);mt.listen({domRefs:ce.value,ignoreDomRefs:a,handler:Ee,button:t.button}),Se(t.target)}))};function Se(t){const s=document.getElementById("tui-chat-main"),e=160,a=t.getBoundingClientRect(),n=s.getBoundingClientRect();me.value=a.top-n.top<e}let se;const j=(t,s,e)=>{if(I.isMultipleSelectMode||I.isNotInGroup||!Ae)return;function a(){clearTimeout(se),te(t,s)}function n(){se=setTimeout(a,500)}function f(){clearTimeout(se)}switch(e){case"touchstart":n();break;case"touchend":f(),setTimeout(()=>{W.value=!1},200);break}},$e=t=>{U("handleEditor",t,"reedit")},Te=t=>{R.value=!0,pe.value=t},Xe=()=>{R.value=!R.value,pe.value.resendMessage()};function V(t){return new Promise(s=>{if(P.value.indexOf(t)<0){P.value.push(t);const a=setTimeout(()=>{P.value.splice(P.value.indexOf(t),1),clearTimeout(a),s()},3e3)}})}async function Ce(){const{scrollHeight:t}=await pt("#messageScrollList"),{height:s}=await dt("#messageScrollList");g.value&&(g.value.scrollTop=t-s)}const ye=Mt.throttle(function(t){var s;(s=Z.value)==null||s.judgeScrollOverOneScreen(t)},150,{leading:!0});async function ze(){var e;if(!p.value||!g.value||p.value.length===0||K===d.value.GRP_AVCHATROOM||K===d.value.GRP_COMMUNITY)return;const t={};m==null||m.disconnect(),m=new IntersectionObserver(a=>{a.forEach(n=>{var S;const{isIntersecting:f,target:D}=n;if(f){const{msgDom:w,msgModel:r}=t[D.id];r&&!((S=r.readReceiptInfo)!=null&&S.isPeerRead)&&!$.has(r.ID)&&(Re.sendMessageReadReceipt([r]),$.add(r.ID),m==null||m.unobserve(w))}})},{root:g.value,threshold:.7});const s=(e=g.value)==null?void 0:e.querySelectorAll(".message-li");if(s)for(let a=0;a<(s==null?void 0:s.length);++a){const n=s[a],f=p.value.find(D=>n.id.slice(4)===D.ID);f&&f.needReadReceipt&&f.flow==="in"&&(t[n.id]={msgDom:n,msgModel:f},m==null||m.observe(n))}}function De(t,s){t&&I.isNotInGroup||(t?ee.value=s:ee.value=void 0,ge.value=t)}function Ee(){A.value=""}function We(){U("closeInputToolBar")}nt(()=>I.isMultipleSelectMode,t=>{t||ke({type:"clearAll",messageID:""})});function ke({type:t,messageID:s}){t==="clearAll"?E.value=[]:t==="add"&&!E.value.includes(s)?E.value.push(s):t==="remove"&&(E.value=E.value.filter(e=>e!==s))}function Qe(){h.update(C.CUSTOM,"multipleForwardMessageID",{isMergeForward:!0,messageIDList:E.value})}function Ze(){h.update(C.CUSTOM,"multipleForwardMessageID",{isMergeForward:!1,messageIDList:E.value})}function et(t){k.value={...k.value,[t]:!0}}return u({oneByOneForwardMessage:Ze,mergeForwardMessage:Qe,scrollToLatestMessage:Ce}),(t,s)=>(i(),O("div",{class:oe(["tui-chat",[o(Ae)?"tui-chat-h5":""]])},[b("div",{id:"tui-chat-main",class:"tui-chat-main",onClick:Ee},[o(He)?(i(),O("div",Vt,[b("span",null,q(o(J).t("TUIChat.【安全提示】本 APP 仅用于体验腾讯云即时通信 IM 产品功能，不可用于业务洽谈与拓展。请勿轻信汇款、中奖等涉及钱款的信息，勿轻易拨打陌生电话，谨防上当受骗。")),1),b("a",{onClick:s[0]||(s[0]=e=>Ye(o(jt).complaint))},q(o(J).t("TUIChat.点此投诉")),1)])):T("",!0),t.isGroup?(i(),c(ht,{key:I.groupID,groupID:I.groupID},null,8,["groupID"])):T("",!0),b("ul",{id:"messageScrollList",ref_key:"messageListRef",ref:g,class:"tui-message-list",onClick:We},[o(re)?T("",!0):(i(),O("p",{key:0,class:"message-more",onClick:Ve},q(o(J).t("TUIChat.查看更多")),1)),(i(!0),O(lt,null,it(o(p),(e,a)=>(i(),O("li",{id:"tui-"+e.ID,key:e.ID,ref_for:!0,ref_key:"messageElementListRef",ref:Q,class:"message-li"},[G(_t,{currTime:e.time,prevTime:a>0?o(p)[a-1].time:0},null,8,["currTime","prevTime"]),b("div",qt,[e.type===o(d).MSG_GRP_TIP||o(Ut)(e)?(i(),c(Et,{key:0,content:e.getMessageContent(),blinkMessageIDList:o(P),onBlinkMessage:V},null,8,["content","blinkMessageIDList"])):e.isRevoked?(i(),c(Rt,{key:1,isEdit:e.type===o(d).MSG_TEXT,messageItem:e,onMessageEdit:n=>$e(e)},null,8,["isEdit","messageItem","onMessageEdit"])):o(Ot)(e)?(i(),c(bt,{key:2,message:o(xt)(e),blinkMessageIDList:o(P),onResendMessage:Te,onHandleToggleMessageItem:te,onHandleH5LongPress:j},null,8,["message","blinkMessageIDList"])):(i(),O("div",{key:3,class:oe({"message-event-bind-div":!0}),onLongpress:n=>te(n,e,!0),onContextmenu:rt(n=>Ke(n,e),["prevent","right"]),onTouchstart:n=>j(n,e,"touchstart"),onTouchend:n=>j(n,e,"touchend"),onMouseover:n=>j(n,e,"touchend")},[G(kt,{content:e.getMessageContent(),isAudioPlayed:!!o(k)[e.ID],blinkMessageIDList:o(P),isMultipleSelectMode:t.isMultipleSelectMode,messageItem:JSON.parse(JSON.stringify(e)),multipleSelectedMessageIDList:o(E),onBlinkMessage:V,onResendMessage:n=>Te(e),onChangeSelectMessageIDList:ke,onSetReadReceiptPanelVisible:De},{messageElement:L(()=>[e.type===o(d).MSG_TEXT?(i(),c(vt,{key:0,content:e.getMessageContent()},null,8,["content"])):e.type===o(d).MSG_IMAGE?(i(),c(ae,{key:1,content:e.getMessageContent(),messageItem:e},{default:L(()=>[G(It,{content:e.getMessageContent(),messageItem:e,onPreviewImage:qe},null,8,["content","messageItem"])]),_:2},1032,["content","messageItem"])):e.type===o(d).MSG_VIDEO?(i(),c(ae,{key:2,content:e.getMessageContent(),messageItem:e},{default:L(()=>[G(Pt,{content:e.getMessageContent(),messageItem:e},null,8,["content","messageItem"])]),_:2},1032,["content","messageItem"])):e.type===o(d).MSG_AUDIO?(i(),c(St,{key:3,content:e.getMessageContent(),messageItem:e,onSetAudioPlayed:et},null,8,["content","messageItem"])):e.type===o(d).MSG_FILE?(i(),c(ae,{key:4,content:e.getMessageContent(),messageItem:e},{default:L(()=>[G(Ct,{content:e.getMessageContent(),messageItem:e},null,8,["content","messageItem"])]),_:2},1032,["content","messageItem"])):e.type===o(d).MSG_MERGER?(i(),c(Tt,{key:5,renderData:e.payload,messageItem:e},null,8,["renderData","messageItem"])):e.type===o(d).MSG_FACE?(i(),c(yt,{key:6,content:e.getMessageContent()},null,8,["content"])):e.type===o(d).MSG_LOCATION?(i(),c(wt,{key:7,content:e.getMessageContent()},null,8,["content"])):e.type===o(d).MSG_CUSTOM?(i(),c(Dt,{key:8,content:e.getMessageContent(),messageItem:e},null,8,["content","messageItem"])):T("",!0)]),TUIEmojiPlugin:L(()=>[o(de)&&e.reactionList.length>0?(i(),c(o(Oe),{key:0,type:"reaction-detail",emojiConfig:o(be),message:o(Nt)(e)},null,8,["emojiConfig","message"])):T("",!0)]),_:2},1032,["content","isAudioPlayed","blinkMessageIDList","isMultipleSelectMode","messageItem","multipleSelectedMessageIDList","onResendMessage"])],40,Jt)),e.ID===o(A)?(i(),c(Lt,{key:4,ref_for:!0,ref_key:"messageToolListRef",ref:X,class:oe({"message-tool":!0,"message-tool-out":e.flow==="out","message-tool-in":e.flow==="in","message-tool-bottom":o(me)}),messageItem:e,isMultipleSelectMode:t.isMultipleSelectMode,onToggleMultipleSelectMode:s[1]||(s[1]=()=>U("toggleMultipleSelectMode"))},{TUIEmojiPlugin:L(()=>[o(de)?(i(),c(o(Oe),{key:0,message:e,emojiConfig:o(be)},null,8,["message","emojiConfig"])):T("",!0)]),_:2},1032,["class","messageItem","isMultipleSelectMode"])):T("",!0)])],8,Yt))),128))],512),G(Gt,{ref_key:"scrollButtonInstanceRef",ref:Z,onScrollToLatestMessage:Ce},null,512),o(R)?(i(),c(Bt,{key:2,class:"resend-dialog",show:o(R),isH5:!o(ne),center:!0,isHeaderShow:o(ne),onSubmit:s[2]||(s[2]=e=>Xe()),"onUpdate:show":s[3]||(s[3]=e=>R.value=e)},{default:L(()=>[b("p",Kt,q(o(J).t("TUIChat.确认重发该消息？")),1)]),_:1},8,["show","isH5","isHeaderShow"])):T("",!0),o(N)?(i(),c(Ht,{key:3,currentImage:o(F),imageList:o(Fe),onClose:Je},null,8,["currentImage","imageList"])):T("",!0),o(ge)?(i(),c(At,{key:4,message:Object.assign({},o(ee)),onSetReadReceiptPanelVisible:De},null,8,["message"])):T("",!0)])],2))}});const Qo=ft($t,[["__scopeId","data-v-d42b96de"]]);export{Qo as default};
