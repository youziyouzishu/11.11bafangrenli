import{k as e,a3 as a,o as t,c as s,w as r,f as l,n as o,a as u,r as n,h as c,t as i,v as d,i as p,H as f,m,aV as _,x as y,a4 as h,d as x,e as w,p as g,F as v,q as k,ad as b,ak as C,bv as S,bw as I,bx as j,by as z,R as V,A as P,aj as A,bz as $,a7 as R,B as F,z as L,ae as N,C as U}from"./index-40b5c4cd.js";import{_ as E}from"./u-button.d0ae8aa1.js";import{_ as O,a as W,g as B,b as q,p as T}from"./pay.44885b19.js";import{f as D,s as G}from"./util.b50fc651.js";import{_ as H}from"./_plugin-vue_export-helper.1b428a4d.js";import{_ as M}from"./u-icon.4067ae16.js";import{_ as X,a as Q}from"./u-radio-group.3f44a23c.js";import{_ as J}from"./u-popup.2526b79a.js";import{u as K}from"./useLockFn.ef459021.js";import{r as Y,a as Z}from"./recharge.33565257.js";import"./emitter.1571a5d9.js";const ee=H(e({__name:"price",props:{content:{default:""},prec:{default:2},autoPrec:{type:Boolean,default:!0},color:{default:"#FA8919"},mainSize:{default:"36rpx"},minorSize:{default:"28rpx"},lineThrough:{type:Boolean,default:!1},fontWeight:{default:"normal"},prefix:{default:"￥"},suffix:{default:""}},setup(e){const m=e,_=a((()=>D({price:m.content,take:"int"}))),y=a((()=>{let e=D({price:m.content,take:"dec",prec:m.prec});return e=e%10==0?e.substr(0,e.length-1):e,m.autoPrec?1*e?"."+e:"":m.prec?"."+e:""}));return(a,m)=>{const h=p,x=f;return t(),s(h,{class:"price-container"},{default:r((()=>[l(h,{class:o(["price-wrap",{"price-wrap--disabled":e.lineThrough}]),style:u({color:e.color})},{default:r((()=>[l(h,{class:"fix-pre",style:u({fontSize:e.minorSize})},{default:r((()=>[n(a.$slots,"prefix",{},(()=>[c(i(e.prefix),1)]),!0)])),_:3},8,["style"]),l(h,{style:u({"font-weight":e.fontWeight})},{default:r((()=>[l(x,{style:u({fontSize:e.mainSize})},{default:r((()=>[c(i(d(_)),1)])),_:1},8,["style"]),l(x,{style:u({fontSize:e.minorSize})},{default:r((()=>[c(i(d(y)),1)])),_:1},8,["style"])])),_:1},8,["style"]),l(h,{class:"fix-suf",style:u({fontSize:e.minorSize})},{default:r((()=>[n(a.$slots,"suffix",{},(()=>[c(i(e.suffix),1)]),!0)])),_:3},8,["style"])])),_:3},8,["class","style"])])),_:3})}}}),[["__scopeId","data-v-a74822ce"]]),ae=H(e({__name:"payment",props:{show:{type:Boolean,required:!0},showCheck:{type:Boolean},orderId:{type:Number,required:!0},from:{type:String,required:!0},redirect:{type:String}},emits:["update:showCheck","update:show","close","success","fail"],setup(e,{emit:o}){const u=e,n=m(),f=m(_.LOADING),R=m({order_amount:"",lists:[]}),F=a({get:()=>u.showCheck,set(e){o("update:showCheck",e)}}),L=a({get:()=>u.show,set(e){o("update:show",e)}}),N=()=>{L.value=!1,o("close")},U=y(),D=G((async()=>{if(0==U.userInfo.is_auth&&[I.OA_WEIXIN,I.MP_WEIXIN].includes(j)&&n.value==z.WECHAT)return(await V({title:"温馨提示",content:"当前账号未绑定微信，无法完成支付",confirmText:"去绑定"})).confirm&&P({url:"/pages/user_set/user_set"}),Promise.reject()}),(async()=>(A({title:"正在支付中"}),await T({order_id:u.orderId,from:u.from,pay_way:n.value,redirect:u.redirect}))),(async e=>{try{return await $.payment(e.pay_way,e.config)}catch(a){return Promise.reject(a)}})),{isLock:H,lockFn:Y}=K((async()=>{try{const e=await D();Z(e),C()}catch(e){C(),console.log(e)}})),Z=e=>{switch(e){case S.SUCCESS:o("success");break;case S.FAIL:o("fail")}},ae=async(e=!0)=>{0===(await B({order_id:u.orderId,from:u.from})).pay_status?(1==e&&uni.$u.toast("您的订单还未支付，请重新支付"),L.value=!0,Z(S.FAIL)):(0==e&&uni.$u.toast("您的订单已经支付，请勿重新支付"),Z(S.SUCCESS)),F.value=!1};return h((()=>u.show),(e=>{if(e){if(!u.orderId)return void(f.value=_.ERROR);(async()=>{f.value=_.LOADING;try{R.value=await q({order_id:u.orderId,from:u.from}),f.value=_.NORMAL;const e=R.value.lists.find((e=>e.is_default))||R.value.lists[0];n.value=null==e?void 0:e.pay_way}catch(e){f.value=_.ERROR}})()}}),{immediate:!0}),(e,a)=>{const o=x(w("u-empty"),O),u=x(w("price"),ee),m=p,_=x(w("u-icon"),M),y=x(w("u-radio"),X),h=x(w("u-radio-group"),Q),C=x(w("u-button"),E),S=x(w("page-status"),W),I=x(w("u-popup"),J);return t(),g(v,null,[l(I,{modelValue:d(L),"onUpdate:modelValue":a[1]||(a[1]=e=>b(L)?L.value=e:null),mode:"bottom","safe-area-inset-bottom":"","mask-close-able":!1,"border-radius":"14",closeable:"",onClose:N},{default:r((()=>[l(m,{class:"h-[900rpx]"},{default:r((()=>[l(S,{status:f.value,fixed:!1},{error:r((()=>[l(o,{text:"订单信息错误，无法查询到订单信息",mode:"order"})])),default:r((()=>[l(m,{class:"payment h-full w-full flex flex-col"},{default:r((()=>[l(m,{class:"header py-[50rpx] flex flex-col items-center"},{default:r((()=>[l(u,{content:R.value.order_amount,mainSize:"44rpx",minorSize:"40rpx",fontWeight:"500",color:"#333"},null,8,["content"])])),_:1}),l(m,{class:"main flex-1 mx-[20rpx]"},{default:r((()=>[l(m,null,{default:r((()=>[l(m,{class:"payway-lists"},{default:r((()=>[l(h,{modelValue:n.value,"onUpdate:modelValue":a[0]||(a[0]=e=>n.value=e),class:"w-full"},{default:r((()=>[(t(!0),g(v,null,k(R.value.lists,((e,a)=>(t(),s(m,{class:"p-[20rpx] flex items-center w-full payway-item",key:a,onClick:a=>{return t=e.pay_way,void(n.value=t);var t}},{default:r((()=>[l(_,{class:"flex-none",size:48,name:e.icon},null,8,["name"]),l(m,{class:"mx-[16rpx] flex-1"},{default:r((()=>[l(m,{class:"payway-item--name flex-1"},{default:r((()=>[c(i(e.name),1)])),_:2},1024),l(m,{class:"text-muted text-xs"},{default:r((()=>[c(i(e.extra),1)])),_:2},1024)])),_:2},1024),l(y,{class:"mr-[-20rpx]",name:e.pay_way},null,8,["name"])])),_:2},1032,["onClick"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1})])),_:1}),l(m,{class:"submit-btn p-[20rpx]"},{default:r((()=>[l(C,{onClick:d(Y),shape:"circle",type:"primary",loading:d(H)},{default:r((()=>[c(" 立即支付 ")])),_:1},8,["onClick","loading"])])),_:1})])),_:1})])),_:1},8,["status"])])),_:1})])),_:1},8,["modelValue"]),l(I,{class:"pay-popup",modelValue:d(F),"onUpdate:modelValue":a[4]||(a[4]=e=>b(F)?F.value=e:null),round:"",mode:"center",borderRadius:"10",maskCloseAble:!1},{default:r((()=>[l(m,{class:"content bg-white w-[560rpx] p-[40rpx]"},{default:r((()=>[l(m,{class:"text-2xl font-medium text-center"},{default:r((()=>[c(" 支付确认 ")])),_:1}),l(m,{class:"pt-[30rpx] pb-[40rpx]"},{default:r((()=>[l(m,null,{default:r((()=>[c(" 请在微信内完成支付，如果您已支付成功，请点击`已完成支付`按钮 ")])),_:1})])),_:1}),l(m,{class:"flex"},{default:r((()=>[l(m,{class:"flex-1 mr-[20rpx]"},{default:r((()=>[l(C,{shape:"circle",type:"primary",plain:"",size:"medium","hover-class":"none",customStyle:{width:"100%"},onClick:a[2]||(a[2]=e=>ae(!1))},{default:r((()=>[c(" 重新支付 ")])),_:1})])),_:1}),l(m,{class:"flex-1"},{default:r((()=>[l(C,{shape:"circle",type:"primary",size:"medium","hover-class":"none",customStyle:{width:"100%"},onClick:a[3]||(a[3]=e=>ae())},{default:r((()=>[c(" 已完成支付 ")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"])],64)}}}),[["__scopeId","data-v-e29de0f9"]]),te=e({__name:"recharge",setup(e){const a=m(""),o=R({orderId:"",from:"",showPay:!1,showCheck:!1,redirect:"/packages/pages/recharge/recharge"}),u=R({user_money:"",min_amount:0}),{isLock:n,lockFn:_}=K((async()=>{const e=u.min_amount;if(!a.value)return uni.$u.toast("请输入充值金额");if(0==e&&Number(a.value)==e)return uni.$u.toast("充值金额必须大于0");if(Number(a.value)<e)return uni.$u.toast(`最低充值金额${e}`);const t=await Z({money:a.value});o.orderId=t.order_id,o.from=t.from,o.showPay=!0})),y=async()=>{o.showPay=!1,o.showCheck=!1,P({url:`/pages/payment_result/payment_result?id=${o.orderId}&from=${o.from}`})},h=async()=>{uni.$u.toast("支付失败")};return F((e=>{(null==e?void 0:e.checkPay)&&(o.orderId=e.id,o.from=e.from,o.showCheck=!0)})),L((()=>{(async()=>{const e=await Y();Object.assign(u,e)})()})),(e,m)=>{const g=p,v=N,k=f,b=x(w("u-button"),E),C=U,S=x(w("payment"),ae);return t(),s(g,{class:"recharge p-[20rpx]"},{default:r((()=>[l(g,{class:"bg-white rounded-[14rpx] p-[40rpx]"},{default:r((()=>[l(g,{class:"text-content"},{default:r((()=>[c("充值金额")])),_:1}),l(g,{class:"border-0 border-b border-solid border-light"},{default:r((()=>[l(v,{modelValue:a.value,"onUpdate:modelValue":m[0]||(m[0]=e=>a.value=e),class:"text-[60rpx] h-[60rpx] py-[24rpx]",placeholder:"0.00",type:"digit"},null,8,["modelValue"])])),_:1}),l(g,{class:"mt-[20rpx] text-xs text-muted"},{default:r((()=>[c(" 当前可用余额 "),l(k,{class:"text-primary"},{default:r((()=>[c(i(u.user_money),1)])),_:1})])),_:1})])),_:1}),l(g,{class:"mt-[40rpx]"},{default:r((()=>[l(b,{loading:d(n),type:"primary",shape:"circle",onClick:d(_)},{default:r((()=>[c(" 立即充值 ")])),_:1},8,["loading","onClick"])])),_:1}),l(g,{class:"flex justify-center m-[60rpx]"},{default:r((()=>[l(C,{url:"/packages/pages/recharge_record/recharge_record","hover-class":"none"},{default:r((()=>[l(k,{class:"text-content text-sm"},{default:r((()=>[c("充值记录")])),_:1})])),_:1})])),_:1}),l(S,{show:o.showPay,"onUpdate:show":m[1]||(m[1]=e=>o.showPay=e),"show-check":o.showCheck,"onUpdate:showCheck":m[2]||(m[2]=e=>o.showCheck=e),"order-id":o.orderId,from:o.from,redirect:o.redirect,onSuccess:y,onFail:h},null,8,["show","show-check","order-id","from","redirect"])])),_:1})}}});export{te as default};
