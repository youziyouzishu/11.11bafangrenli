import{W as e,I as t,J as i,K as n,L as o,M as a,N as s,O as r,P as c,$ as l,Q as u,R as d,g as m,S as h,T as p,U as f,A as g,V as _,X as C,Y as v,d as w,e as y,o as x,c as k,w as I,f as b,h as M,j as T,Z as j,_ as S,a as L,p as U,F as V,q as B,E as $,n as N,t as W,H as z,i as H,a0 as R,x as E,y as G,m as P}from"./index-40b5c4cd.js";import{_ as D}from"./cloud-image.bb0ddc22.js";import{_ as F}from"./uni-icons.4f8d1bfc.js";import{_ as J,a as O}from"./uni-list-item.88aca6c2.js";import{c as Q,n as q,a as A,g as K,b as X,d as Y,e as Z,_ as ee}from"./info.ed04b221.js";import{_ as te}from"./uni-list-chat.abf53d2c.js";import{_ as ie}from"./uni-load-more.0f0e0cfa.js";import{_ as ne}from"./uni-list.8cb35de1.js";import{_ as oe}from"./tabbar.vue_vue_type_script_setup_true_lang.45a154e4.js";import ae from"./uni_modules-uni-im-pages-chat-chat.bf00f51b.js";import{_ as se}from"./_plugin-vue_export-helper.1b428a4d.js";import"./uni-popup-dialog.91400977.js";import"./uni-popup.52abe24b.js";import"./u-icon.4067ae16.js";import"./u-badge.a768d844.js";import"./util.b50fc651.js";const re=e.database();let ce=!1,le=0;const ue=se({components:{chatView:ae,"uni-im-contacts":Q,"uni-im-notification":q,"uni-im-addPeopleGroups":A,"uni-im-groupList":K,"uni-im-createGroup":X,"uni-im-chat-info":Y,"uni-im-group-info":Z},data:()=>({wHeight:"auto",userInfo:{},dynamicComponentName:"uni-im-addPeopleGroups",view2Title:"加人/加群",showContactsView:!1,chatInfoIsShow:!1,currentConversation:{}}),computed:{conversationList(){le++;let e=t.conversation.dataList;return setTimeout((()=>{le=0}),1e3),le>6?e:e.sort((function(e,i){if(i.id==t.currentConversationId)return 0;i.chatText&&(i.update_time=Date.now());let n=e.update_time||0,o=i.update_time||0,a=e.msgList.length,s=i.msgList.length;if(a){let t=e.msgList[a-1].create_time;t>n&&(n=t)}if(s){let e=i.msgList[s-1].create_time;e>o&&(o=e)}return o-n}))},loadMoreContentText(){return{contentrefresh:"正在加载...",contentnomore:this.conversationList.length?"没有更多数据了":"没有会话数据"}},conversationHasMore:()=>t.conversation.hasMore,...t.mapState(["currentConversationId","isWidescreen"]),unreadMsgCount:()=>t.conversation.unreadCount(),unreadnotificationCount:()=>t.notification.unreadCount(),currentUserInfo:()=>i.userInfo,avatarUrl(){return this.currentUserInfo.avatar_file&&this.currentUserInfo.avatar_file.url?this.currentUserInfo.avatar_file.url:"/uni_modules/uni-im/static/avatarUrl.png"}},watch:{unreadMsgCount(e){console.log({unreadMsgCount:e}),0==e?n({index:0,complete:e=>{console.log(e)}}):o({index:0,text:e+"",complete:e=>{}})},showContactsView(e){e?(ce=this.currentConversationId,t.currentConversationId=!1):ce&&(t.currentConversationId=ce,this.$nextTick((()=>{this.toChat(ce)})))},async currentConversationId(e){this.currentConversation=await t.conversation.get(e)}},created(){},async onLoad(t){let{token:i,user_id:n,conversation_id:o,joinGroup:m}=t,h="2023-05-22-01",p=a("uni-im-storage-version");p&&p!=h&&(s("uni-im-storage-version",h),r());let{tokenExpired:f}=e.getCurrentUserInfo();if(!f||f<Date.now()){console.info("当前用户的登录状态无效，将自动跳转至登录页面。",t);let e="/pages/login/login?uniIdRedirectUrl=",i="/uni_modules/uni-im/pages/index/index?";for(let n in t)i+=`${n}=${t[n]}&`;return i=i.substring(0,i.length-1),e+=encodeURIComponent(i),c({url:e})}if(this.$nextTick((()=>{this.init({user_id:n,conversation_id:o})})),this.onLoginSuccess=async()=>{this.init({user_id:n,conversation_id:o})},l("uni-id-pages-login-success",this.onLoginSuccess),l("uni-im-toChat",(e=>{e&&(ce=!1,this.toChat(e)),this.showContactsView=!1})),m){let e=m;history.pushState({},"","/#/"),console.log("group_id",e),re.collection("uni-im-group-join").add({group_id:e,message:""}).then((e=>{console.log("res: ",e),u({icon:"none",title:"已申请"})})).catch((e=>{d({content:e.message||"请求服务失败",showCancel:!1})}))}},async onReady(){let e=m();if(t.systemInfo=e,!["edge","chrome","safari"].includes(e.browserName)){let e=document.createElement("div");e.innerHTML='\n\t\t\t\t<div style="background: #fff9ea;color: #ff9a43;position: fixed;top: 0;left: 0;width: 100vw;padding: 15px;font-size: 18px;">\n\t\t\t\t\t注意：本系统仅兼容chrome、edge、safari浏览器\n\t\t\t\t</div>\n\t\t\t\t',document.body.appendChild(e)}},onUnload(){h("uni-id-pages-login-success",this.onLoginSuccess)},onHide(){},methods:{clickSearchBarBox(){u({title:"暂不支持",icon:"none"})},loadMore:async()=>await t.conversation.loadMore(),clickMenu(e){this.dynamicComponentName=e.componentName,e.title&&(this.view2Title=e.title),e.param&&this.$nextTick((()=>{this.$refs.dynamicComponent.setParam(e.param)})),"uni-im-createGroup"==e.componentName&&this.$nextTick((()=>{this.$refs.dynamicComponent.getFriendsData()}))},readQrCode(){p({complete:e=>{try{let t=JSON.parse(e.result);"uni-im"==t.type&&t.subType}catch(t){}}})},async init({conversation_id:e,user_id:i}){if(await this.loadMore(),e)this.toChat(e);else if(i){const e=await t.conversation.get({friend_uid:i});this.toChat(e.id)}else if(this.isWidescreen){let[e]=this.conversationList;e&&(this.currentConversation=await t.conversation.get(e.id),this.toChat(e.id))}},search(e){u({title:"加好友功能入口，暂时在左侧菜单的通讯录中",icon:"none",duration:3e3})},addUser(){u({title:"加好友功能入口，暂时在左侧菜单的通讯录中",icon:"none",duration:3e3})},async toChat(e){this.chatInfoIsShow=!1;let i="";if("string"==typeof e)i=e;else if(e.conversation_id)i=e.conversation_id;else if(e.group_id)i="group_"+e.group_id;else{if(!e.user_id&&!e.friend_uid)throw new Error("toChat param is error");i=f.getConversationId(e.user_id||e.friend_uid)}t.currentConversationId=i,this.isWidescreen?this.$nextTick((()=>{let e=this.$refs["chat-view"];e&&e.load(i)})):g({url:"/uni_modules/uni-im/pages/chat/chat?conversation_id="+i,animationDuration:300})},showChatInfo(){this.chatInfoIsShow=!this.chatInfoIsShow},toUcenter(){g({url:"/uni_modules/uni-id-pages/pages/userinfo/userinfo?showLoginManage=true",complete(e){console.log("e: "+JSON.stringify(e))}})},friendlyTime:e=>f.toFriendlyTime(e)},async onReachBottom(){await this.loadMore()},onNavigationBarButtonTap(e){if(e.index){_().keys.forEach((e=>{(e.includes("uni-im-msg:")||e.includes("uni-im-conversation"))&&C(e)})),u({title:"clear storage ok",icon:"none"})}else g({url:"/uni_modules/uni-id-pages/pages/userinfo/userinfo?showLoginManage=true",complete:e=>{console.log(e)}})}},[["render",function(e,t,i,n,o,a){const s=z,r=v("uni-link"),c=H,l=w(y("cloud-image"),D),u=w(y("uni-icons"),F),d=w(y("uni-badge"),J),m=w(y("uni-search-bar"),ee),h=v("uni-im-contacts"),p=w(y("uni-list-chat"),te),f=w(y("uni-load-more"),ie),g=w(y("uni-list-item"),O),_=w(y("uni-list"),ne),C=R,E=v("chat-view"),G=v("uni-im-group-info"),P=v("uni-im-chat-info"),Q=w(y("tabbar"),oe);return x(),k(c,{id:"page"},{default:I((()=>[e.isWidescreen?(x(),k(c,{key:0,id:"about",space:"nbsp"},{default:I((()=>[b(s,null,{default:I((()=>[M("欢迎体验uni-im ​")])),_:1}),b(r,{href:"https://ext.dcloud.net.cn/plugin?id=9711",text:"[点此下载插件]"})])),_:1})):T("",!0),e.isWidescreen?(x(),k(c,{key:1,id:"left-view",onClick:t[2]||(t[2]=e=>{o.chatInfoIsShow=!1})},{default:I((()=>[b(l,{class:"user-avatar",onClick:a.toUcenter,src:a.avatarUrl,width:"40px",height:"40px",borderRadius:"100px"},null,8,["onClick","src"]),b(d,{size:"small",text:a.unreadMsgCount,absolute:"rightTop",type:"error"},{default:I((()=>[b(u,{class:"chat-icon",onClick:t[0]||(t[0]=e=>o.showContactsView=!1),color:o.showContactsView?"#c5c5c5":"#5fc08e",size:"32",type:"chatbubble-filled"},null,8,["color"])])),_:1},8,["text"]),b(d,{size:"small",text:a.unreadnotificationCount,absolute:"rightTop",type:"error"},{default:I((()=>[b(u,{onClick:t[1]||(t[1]=e=>o.showContactsView=!0),color:o.showContactsView?"#5fc08e":"#c5c5c5",size:"32",type:"staff-filled"},null,8,["color"])])),_:1},8,["text"])])),_:1})):T("",!0),b(c,{id:"center-view"},{default:I((()=>[e.isWidescreen?(x(),k(c,{key:0,id:"search-bar-box",onClick:a.clickSearchBarBox},{default:I((()=>[b(m,{readonly:!0,id:"search-bar",radius:"5",placeholder:"搜索",clearButton:"auto",cancelButton:"none"}),b(u,{color:"#848386",size:"26",type:"plus"})])),_:1},8,["onClick"])):T("",!0),j(b(c,{id:"uni-im-contacts-box"},{default:I((()=>[b(h,{onClickMenu:a.clickMenu,id:"uni-im-contacts"},null,8,["onClickMenu"])])),_:1},512),[[S,e.isWidescreen&&o.showContactsView]]),b(C,{id:"user-list-box","scroll-y":"true",onScrolltolower:t[3]||(t[3]=e=>a.loadMore())},{default:I((()=>[b(_,{class:"user-list",style:L({height:o.wHeight,width:"750rpx"}),border:!1},{default:I((()=>[(x(!0),U(V,null,B(a.conversationList,((t,i)=>(x(),k(p,{onContextmenu:$((e=>a.toChat(t.id)),["prevent"]),key:t.id,showBadge:t.unread_count>0,badgeText:t.unread_count,link:"",title:t.title,class:N(["user-list-item",{activeConversation:e.currentConversationId==t.id}]),note:t.last_msg_note,avatar:t.avatar_file&&t.avatar_file.url?t.avatar_file.url:"/uni_modules/uni-im/static/avatarUrl.png",onClick:e=>a.toChat(t.id),direction:"column",time:a.friendlyTime(t.update_time),hasCallMe:t.call_list.length},{header:I((()=>[t.group_id?(x(),k(s,{key:0,class:"group-icon"},{default:I((()=>[M("群")])),_:1})):T("",!0)])),_:2},1032,["onContextmenu","showBadge","badgeText","title","class","note","avatar","onClick","time","hasCallMe"])))),128)),b(g,{customStyle:{backgroundColor:"#f5f5f5",padding:0}},{body:I((()=>[b(f,{class:"tip",contentText:a.loadMoreContentText,status:a.conversationHasMore?"loading":"noMore"},null,8,["contentText","status"])])),_:1})])),_:1},8,["style"])])),_:1})])),_:1}),e.isWidescreen?(x(),k(c,{key:2,id:"right-view"},{default:I((()=>[b(c,{id:"chat-view-box"},{default:I((()=>[!o.showContactsView&&e.currentConversationId?(x(),U(V,{key:0},[o.showContactsView?T("",!0):(x(),k(c,{key:0,id:"chat-header"},{default:I((()=>[b(s,{selectable:!0},{default:I((()=>[M(W(o.currentConversation.title),1)])),_:1}),b(u,{onClick:a.showChatInfo,class:"more",type:"more-filled",size:"20"},null,8,["onClick"])])),_:1})),b(c,{id:"chat-view"},{default:I((()=>[b(E,{ref:"chat-view"},null,512)])),_:1}),o.chatInfoIsShow?(x(),k(c,{key:1,class:"chatInfoBox",onClick:t[6]||(t[6]=$((e=>o.chatInfoIsShow=!1),["stop"]))},{default:I((()=>[o.currentConversation.group_id?(x(),k(G,{key:0,onClick:t[4]||(t[4]=$((()=>{}),["stop"])),conversation_id:o.currentConversation.id},null,8,["conversation_id"])):(x(),k(P,{key:1,onClick:t[5]||(t[5]=$((()=>{}),["stop"])),conversation_id:o.currentConversation.id},null,8,["conversation_id"]))])),_:1})):T("",!0)],64)):(x(),k(c,{key:1,id:"ccid-is-null-tip"},{default:I((()=>[M(" 未选择会话对象 ")])),_:1}))])),_:1}),j(b(c,{id:"dynamic-component-box"},{default:I((()=>[b(c,{class:"dynamic-component-title"},{default:I((()=>[M(W(o.view2Title),1)])),_:1}),(x(),k(y(o.dynamicComponentName),{ref:"dynamicComponent"},null,512))])),_:1},512),[[S,o.showContactsView]])])),_:1})):T("",!0),b(Q)])),_:1})}],["__scopeId","data-v-ca2fcc1a"]]),de=se({__name:"msg",setup(e){const t=E();return G(t),P(null),P(null),P([]),(e,t)=>{const i=H,n=w(y("im-list"),ue),o=w(y("tabbar"),oe);return x(),U(V,null,[b(i,{class:""}),b(n),b(o)],64)}}},[["__scopeId","data-v-46774df6"]]);export{de as default};
