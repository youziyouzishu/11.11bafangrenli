import{W as e,I as t,J as i,K as n,L as o,g as a,U as s,M as r,N as c,O as l,P as u,$ as d,Q as h,R as m,S as p,T as f,A as g,V as _,X as v,o as C,p as w,f as y,w as k,c as I,j as x,F as b,i as M,h as T,Z as S,_ as j,a as L,q as U,t as $,E as B,e as V,H as N,d as W,Y as H,a0 as R,n as E}from"./index-40b5c4cd.js";import{_ as z}from"./uni-icons.4f8d1bfc.js";import{_ as G,a as P}from"./uni-list-item.88aca6c2.js";import{c as Q,n as D,a as J,g as O,b as F,d as q,e as A,_ as K}from"./info.ed04b221.js";import{_ as X}from"./uni-list-chat.abf53d2c.js";import{_ as Y}from"./uni-load-more.0f0e0cfa.js";import{_ as Z}from"./uni-list.8cb35de1.js";import{_ as ee}from"./tabbar.vue_vue_type_script_setup_true_lang.45a154e4.js";import te from"./uni_modules-uni-im-pages-chat-chat.bf00f51b.js";import{_ as ie}from"./_plugin-vue_export-helper.1b428a4d.js";import"./uni-popup-dialog.91400977.js";import"./uni-popup.52abe24b.js";import"./u-icon.4067ae16.js";import"./u-badge.a768d844.js";import"./util.b50fc651.js";import"./cloud-image.bb0ddc22.js";const ne=e.database();let oe=!1,ae=0;const se=ie({components:{chatView:te,"uni-im-contacts":Q,"uni-im-notification":D,"uni-im-addPeopleGroups":J,"uni-im-groupList":O,"uni-im-createGroup":F,"uni-im-chat-info":q,"uni-im-group-info":A},data:()=>({wHeight:"auto",userInfo:{},dynamicComponentName:"uni-im-addPeopleGroups",view2Title:"加人/加群",showContactsView:!1,chatInfoIsShow:!1,currentConversation:{}}),computed:{conversationList(){ae++;let e=t.conversation.dataList;return setTimeout((()=>{ae=0}),1e3),ae>6?e:e.sort((function(e,i){if(i.id==t.currentConversationId)return 0;i.chatText&&(i.update_time=Date.now());let n=e.update_time||0,o=i.update_time||0,a=e.msgList.length,s=i.msgList.length;if(a){let t=e.msgList[a-1].create_time;t>n&&(n=t)}if(s){let e=i.msgList[s-1].create_time;e>o&&(o=e)}return o-n}))},loadMoreContentText(){return{contentrefresh:"正在加载...",contentnomore:this.conversationList.length?"没有更多数据了":"没有会话数据"}},conversationHasMore:()=>t.conversation.hasMore,...t.mapState(["currentConversationId","isWidescreen"]),unreadMsgCount:()=>t.conversation.unreadCount(),unreadnotificationCount:()=>t.notification.unreadCount(),currentUserInfo:()=>i.userInfo,avatarUrl(){return this.currentUserInfo.avatar_file&&this.currentUserInfo.avatar_file.url?this.currentUserInfo.avatar_file.url:"/uni_modules/uni-im/static/avatarUrl.png"}},watch:{unreadMsgCount(e){console.log({unreadMsgCount:e}),0==e?n({index:0,complete:e=>{console.log(e)}}):o({index:0,text:e+"",complete:e=>{}})},showContactsView(e){e?(oe=this.currentConversationId,t.currentConversationId=!1):oe&&(t.currentConversationId=oe,this.$nextTick((()=>{this.toChat(oe)})))},async currentConversationId(e){this.currentConversation=await t.conversation.get(e)}},created(){this.wHeight=a().windowHeight-50+"px",console.log("uniIm",this.wHeight);let e=this.getQueryString("token");if(e){let t=JSON.parse(e);console.log("token",t),s.login(t)}},async onLoad(t){let{token:i,user_id:n,conversation_id:o,joinGroup:a}=t,s="2023-05-22-01",p=r("uni-im-storage-version");p&&p!=s&&(c("uni-im-storage-version",s),l());let{tokenExpired:f}=e.getCurrentUserInfo();if(!f||f<Date.now()){console.info("当前用户的登录状态无效，将自动跳转至登录页面。",t);let e="/uni_modules/uni-id-pages/pages/login/login-withpwd?uniIdRedirectUrl=",i="/uni_modules/uni-im/pages/index/index?";for(let n in t)i+=`${n}=${t[n]}&`;return i=i.substring(0,i.length-1),e+=encodeURIComponent(i),u({url:e})}if(this.$nextTick((()=>{this.init({user_id:n,conversation_id:o})})),this.onLoginSuccess=async()=>{this.init({user_id:n,conversation_id:o})},d("uni-id-pages-login-success",this.onLoginSuccess),d("uni-im-toChat",(e=>{e&&(oe=!1,this.toChat(e)),this.showContactsView=!1})),a){let e=a;history.pushState({},"","/#/"),console.log("group_id",e),ne.collection("uni-im-group-join").add({group_id:e,message:""}).then((e=>{console.log("res: ",e),h({icon:"none",title:"已申请"})})).catch((e=>{m({content:e.message||"请求服务失败",showCancel:!1})}))}},async onReady(){let e=a();if(t.systemInfo=e,!["edge","chrome","safari"].includes(e.browserName)){let e=document.createElement("div");e.innerHTML='\n\t\t\t\t<div style="background: #fff9ea;color: #ff9a43;position: fixed;top: 0;left: 0;width: 100vw;padding: 15px;font-size: 18px;">\n\t\t\t\t\t注意：本系统仅兼容chrome、edge、safari浏览器\n\t\t\t\t</div>\n\t\t\t\t',document.body.appendChild(e)}},onUnload(){p("uni-id-pages-login-success",this.onLoginSuccess)},onHide(){},methods:{getQueryString(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),i=window.location.search.substr(1).match(t);return null!=i?unescape(i[2]):null},clickSearchBarBox(){h({title:"暂不支持",icon:"none"})},loadMore:async()=>await t.conversation.loadMore(),clickMenu(e){this.dynamicComponentName=e.componentName,e.title&&(this.view2Title=e.title),e.param&&this.$nextTick((()=>{this.$refs.dynamicComponent.setParam(e.param)})),"uni-im-createGroup"==e.componentName&&this.$nextTick((()=>{this.$refs.dynamicComponent.getFriendsData()}))},readQrCode(){f({complete:e=>{try{let t=JSON.parse(e.result);"uni-im"==t.type&&t.subType}catch(t){}}})},async init({conversation_id:e,user_id:i}){if(await this.loadMore(),e)this.toChat(e);else if(i){const e=await t.conversation.get({friend_uid:i});this.toChat(e.id)}else if(this.isWidescreen){let[e]=this.conversationList;e&&(this.currentConversation=await t.conversation.get(e.id),this.toChat(e.id))}},search(e){h({title:"加好友功能入口，暂时在左侧菜单的通讯录中",icon:"none",duration:3e3})},addUser(){h({title:"加好友功能入口，暂时在左侧菜单的通讯录中",icon:"none",duration:3e3})},async toChat(e){this.chatInfoIsShow=!1;let i="";if("string"==typeof e)i=e;else if(e.conversation_id)i=e.conversation_id;else if(e.group_id)i="group_"+e.group_id;else{if(!e.user_id&&!e.friend_uid)throw new Error("toChat param is error");i=s.getConversationId(e.user_id||e.friend_uid)}t.currentConversationId=i,this.isWidescreen?this.$nextTick((()=>{let e=this.$refs["chat-view"];e&&e.load(i)})):g({url:"/uni_modules/uni-im/pages/chat/chat?conversation_id="+i,animationDuration:300})},showChatInfo(){this.chatInfoIsShow=!this.chatInfoIsShow},toUcenter(){g({url:"/uni_modules/uni-id-pages/pages/userinfo/userinfo?showLoginManage=true",complete(e){console.log("e: "+JSON.stringify(e))}})},friendlyTime:e=>s.toFriendlyTime(e)},async onReachBottom(){await this.loadMore()},onNavigationBarButtonTap(e){if(e.index){_().keys.forEach((e=>{(e.includes("uni-im-msg:")||e.includes("uni-im-conversation"))&&v(e)})),h({title:"clear storage ok",icon:"none"})}else g({url:"/uni_modules/uni-id-pages/pages/userinfo/userinfo?showLoginManage=true",complete:e=>{console.log(e)}})}},[["render",function(e,t,i,n,o,a){const s=N,r=M,c=W(V("uni-icons"),z),l=W(V("uni-badge"),G),u=W(V("uni-search-bar"),K),d=H("uni-im-contacts"),h=W(V("uni-list-chat"),X),m=W(V("uni-load-more"),Y),p=W(V("uni-list-item"),P),f=W(V("uni-list"),Z),g=R,_=H("chat-view"),v=H("uni-im-group-info"),Q=H("uni-im-chat-info"),D=W(V("tabbar"),ee);return C(),w(b,null,[y(r,{id:"page"},{default:k((()=>[e.isWidescreen?(C(),I(r,{key:0,id:"about",space:"nbsp"},{default:k((()=>[y(s,null,{default:k((()=>[T("客服系统 ​")])),_:1})])),_:1})):x("",!0),e.isWidescreen?(C(),I(r,{key:1,id:"left-view",onClick:t[1]||(t[1]=e=>{o.chatInfoIsShow=!1})},{default:k((()=>[y(l,{size:"small",text:a.unreadMsgCount,absolute:"rightTop",type:"error"},{default:k((()=>[y(c,{class:"chat-icon",onClick:t[0]||(t[0]=e=>o.showContactsView=!1),color:o.showContactsView?"#c5c5c5":"#5fc08e",size:"32",type:"chatbubble-filled"},null,8,["color"])])),_:1},8,["text"])])),_:1})):x("",!0),y(r,{id:"center-view"},{default:k((()=>[e.isWidescreen?(C(),I(r,{key:0,id:"search-bar-box",onClick:a.clickSearchBarBox},{default:k((()=>[y(u,{readonly:!0,id:"search-bar",radius:"5",placeholder:"搜索",clearButton:"auto",cancelButton:"none"}),y(c,{color:"#848386",size:"26",type:"plus"})])),_:1},8,["onClick"])):x("",!0),S(y(r,{id:"uni-im-contacts-box"},{default:k((()=>[y(d,{onClickMenu:a.clickMenu,id:"uni-im-contacts"},null,8,["onClickMenu"])])),_:1},512),[[j,e.isWidescreen&&o.showContactsView]]),y(g,{id:"user-list-box","scroll-y":"true",onScrolltolower:t[2]||(t[2]=e=>a.loadMore())},{default:k((()=>[y(f,{class:"user-list",style:L({height:o.wHeight,width:"750rpx"}),border:!1},{default:k((()=>[(C(!0),w(b,null,U(a.conversationList,((t,i)=>(C(),I(h,{onContextmenu:B((e=>a.toChat(t.id)),["prevent"]),key:t.id,showBadge:t.unread_count>0,badgeText:t.unread_count,link:"",title:t.title,class:E(["user-list-item",{activeConversation:e.currentConversationId==t.id}]),note:t.last_msg_note,avatar:t.avatar_file&&t.avatar_file.url?t.avatar_file.url:"/uni_modules/uni-im/static/avatarUrl.png",onClick:e=>a.toChat(t.id),direction:"column",time:a.friendlyTime(t.update_time),hasCallMe:t.call_list.length},{header:k((()=>[t.group_id?(C(),I(s,{key:0,class:"group-icon"},{default:k((()=>[T("群")])),_:1})):x("",!0)])),_:2},1032,["onContextmenu","showBadge","badgeText","title","class","note","avatar","onClick","time","hasCallMe"])))),128)),y(p,{customStyle:{backgroundColor:"#f5f5f5",padding:0}},{body:k((()=>[y(m,{class:"tip",contentText:a.loadMoreContentText,status:a.conversationHasMore?"loading":"noMore"},null,8,["contentText","status"])])),_:1})])),_:1},8,["style"])])),_:1})])),_:1}),e.isWidescreen?(C(),I(r,{key:2,id:"right-view"},{default:k((()=>[y(r,{id:"chat-view-box"},{default:k((()=>[!o.showContactsView&&e.currentConversationId?(C(),w(b,{key:0},[o.showContactsView?x("",!0):(C(),I(r,{key:0,id:"chat-header"},{default:k((()=>[y(s,{selectable:!0},{default:k((()=>[T($(o.currentConversation.title),1)])),_:1}),y(c,{onClick:a.showChatInfo,class:"more",type:"more-filled",size:"20"},null,8,["onClick"])])),_:1})),y(r,{id:"chat-view"},{default:k((()=>[y(_,{ref:"chat-view"},null,512)])),_:1}),o.chatInfoIsShow?(C(),I(r,{key:1,class:"chatInfoBox",onClick:t[5]||(t[5]=B((e=>o.chatInfoIsShow=!1),["stop"]))},{default:k((()=>[o.currentConversation.group_id?(C(),I(v,{key:0,onClick:t[3]||(t[3]=B((()=>{}),["stop"])),conversation_id:o.currentConversation.id},null,8,["conversation_id"])):(C(),I(Q,{key:1,onClick:t[4]||(t[4]=B((()=>{}),["stop"])),conversation_id:o.currentConversation.id},null,8,["conversation_id"]))])),_:1})):x("",!0)],64)):(C(),I(r,{key:1,id:"ccid-is-null-tip"},{default:k((()=>[T(" 未选择会话对象 ")])),_:1}))])),_:1}),S(y(r,{id:"dynamic-component-box"},{default:k((()=>[y(r,{class:"dynamic-component-title"},{default:k((()=>[T($(o.view2Title),1)])),_:1}),(C(),I(V(o.dynamicComponentName),{ref:"dynamicComponent"},null,512))])),_:1},512),[[j,o.showContactsView]])])),_:1})):x("",!0)])),_:1}),e.isWidescreen?x("",!0):(C(),I(r,{key:0,id:"bottom-view"},{default:k((()=>[y(D)])),_:1}))],64)}],["__scopeId","data-v-a6ceb416"]]);export{se as default};
