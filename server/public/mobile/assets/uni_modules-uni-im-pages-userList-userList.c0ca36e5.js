import{bb as e,bs as t,bt as i,a2 as n,aj as o,W as a,Q as s,R as l,ak as r,o as c,c as d,w as u,r as h,a5 as p,i as g,I as m,bd as f,V as y,X as _,M as C,A as v,f as b,h as w,t as S,p as D,q as L,F as M,H as x,d as I,e as k}from"./index-40b5c4cd.js";import{_ as E}from"./uni-list-chat.abf53d2c.js";import{_ as T}from"./uni-list.8cb35de1.js";import{_ as j}from"./uni-load-more.0f0e0cfa.js";import{_ as B}from"./_plugin-vue_export-helper.1b428a4d.js";const z={en:{"uniCloud.component.add.success":"Success","uniCloud.component.update.success":"Success","uniCloud.component.remove.showModal.title":"Tips","uniCloud.component.remove.showModal.content":"是否删除该数据"},es:{"uniCloud.component.add.success":"新增成功","uniCloud.component.update.success":"修改成功","uniCloud.component.remove.showModal.title":"提示","uniCloud.component.remove.showModal.content":"是否删除该数据"},fr:{"uniCloud.component.add.success":"新增成功","uniCloud.component.update.success":"修改成功","uniCloud.component.remove.showModal.title":"提示","uniCloud.component.remove.showModal.content":"是否删除该数据"},"zh-Hans":{"uniCloud.component.add.success":"新增成功","uniCloud.component.update.success":"修改成功","uniCloud.component.remove.showModal.title":"提示","uniCloud.component.remove.showModal.content":"是否删除该数据"},"zh-Hant":{"uniCloud.component.add.success":"新增成功","uniCloud.component.update.success":"修改成功","uniCloud.component.remove.showModal.title":"提示","uniCloud.component.remove.showModal.content":"是否刪除數據"}},A=Array.isArray,{t:F}=e(z),O="load",$="error",K="add",N="replace",W="auto",R="manual",J=["pageCurrent","pageSize","collection","action","field","getcount","orderby","where","groupby","groupField","distinct"];const P=B({name:"UniClouddb",setup(e){const o=e.ssrKey?e.getone?t(void 0,e.ssrKey):i([],e.ssrKey):e.getone?t(void 0,"ChGeAsj6G8osJWmfdk+t2A=="):i([],"DOl4uQCmayqQAVJyYCGqPg=="),a=p();return n((()=>{o.value&&0!==o.value.length||e.manual||e.loadtime!==W||a.proxy.loadData()})),{dataList:o}},async serverPrefetch(){if(!this.manual&&this.loadtime===W)return this.loadData()},props:{options:{type:[Object,Array],default:()=>({})},spaceInfo:{type:Object,default:()=>({})},collection:{type:[String,Array],default:""},action:{type:String,default:""},field:{type:String,default:""},orderby:{type:String,default:""},where:{type:[String,Object],default:""},pageData:{type:String,default:"add"},pageCurrent:{type:Number,default:1},pageSize:{type:Number,default:20},getcount:{type:[Boolean,String],default:!1},getone:{type:[Boolean,String],default:!1},gettree:{type:[Boolean,String,Object],default:!1},gettreepath:{type:[Boolean,String],default:!1},startwith:{type:String,default:""},limitlevel:{type:Number,default:10},groupby:{type:String,default:""},groupField:{type:String,default:""},distinct:{type:[Boolean,String],default:!1},pageIndistinct:{type:[Boolean,String],default:!1},foreignKey:{type:String,default:""},loadtime:{type:String,default:"auto"},manual:{type:Boolean,default:!1},ssrKey:{type:[String,Number],default:""}},data:()=>({loading:!1,hasMore:!1,paginationInternal:{},errorMessage:""}),computed:{collectionArgs(){return A(this.collection)?this.collection:[this.collection]},isLookup(){return A(this.collection)&&this.collection.length>1||"string"==typeof this.collection&&this.collection.indexOf(",")>-1},mainCollection(){if("string"==typeof this.collection)return this.collection.split(",")[0];return JSON.parse(JSON.stringify(this.collection[0])).$db[0].$param[0]}},created(){this._isEnded=!1,this.paginationInternal={current:this.pageCurrent,size:this.pageSize,count:0},this.$watch((()=>{var e=[];return J.forEach((t=>{e.push(this[t])})),e}),((e,t)=>{if(this.paginationInternal.size=this.pageSize,e[0]!==t[0]&&(this.paginationInternal.current=this.pageCurrent),this.loadtime===R)return;let i=!1;for(let n=2;n<e.length;n++)if(e[n]!==t[n]){i=!0;break}i&&(this.clear(),this.reset()),this._execLoadData()}))},methods:{loadData(e,t){let i=null,n=!1;return"object"==typeof e?(e.clear&&(this.pageData===N?this.clear():n=e.clear,this.reset()),void 0!==e.current&&(this.paginationInternal.current=e.current),"function"==typeof t&&(i=t)):"function"==typeof e&&(i=e),this._execLoadData(i,n)},loadMore(){this._isEnded||this.loading||(this.pageData===K&&this.paginationInternal.current++,this._execLoadData())},refresh(){this.clear(),this._execLoadData()},clear(){this._isEnded=!1,this.dataList=[]},reset(){this.paginationInternal.current=1},add(e,{action:t,showToast:i=!0,toastTitle:n,success:c,fail:d,complete:u,needConfirm:h=!0,needLoading:p=!0,loadingTitle:g=""}={}){p&&o({title:g});let m=a.database(this.spaceInfo);t&&(m=m.action(t)),m.collection(this.mainCollection).add(e).then((e=>{c&&c(e),i&&s({title:n||F("uniCloud.component.add.success")})})).catch((e=>{d&&d(e),h&&l({content:e.message,showCancel:!1})})).finally((()=>{p&&r(),u&&u()}))},remove(e,{action:t,success:i,fail:n,complete:o,confirmTitle:a,confirmContent:s,needConfirm:r=!0,needLoading:c=!0,loadingTitle:d=""}={}){e&&e.length&&(r?l({title:a||F("uniCloud.component.remove.showModal.title"),content:s||F("uniCloud.component.remove.showModal.content"),showCancel:!0,success:a=>{a.confirm&&this._execRemove(e,t,i,n,o,r,c,d)}}):this._execRemove(e,t,i,n,o,r,c,d))},update(e,t,{action:i,showToast:n=!0,toastTitle:c,success:d,fail:u,complete:h,needConfirm:p=!0,needLoading:g=!0,loadingTitle:m=""}={}){g&&o({title:m});let f=a.database(this.spaceInfo);return i&&(f=f.action(i)),f.collection(this.mainCollection).doc(e).update(t).then((e=>{d&&d(e),n&&s({title:c||F("uniCloud.component.update.success")})})).catch((e=>{u&&u(e),p&&l({content:e.message,showCancel:!1})})).finally((()=>{g&&r(),h&&h()}))},getTemp(e=!0){let t=a.database(this.spaceInfo);this.action&&(t=t.action(this.action)),t=t.collection(...this.collectionArgs),this.foreignKey&&(t=t.foreignKey(this.foreignKey)),this.where&&Object.keys(this.where).length&&(t=t.where(this.where)),this.field&&(t=t.field(this.field)),this.groupby&&(t=t.groupBy(this.groupby)),this.groupField&&(t=t.groupField(this.groupField)),!0===this.distinct&&(t=t.distinct()),this.orderby&&(t=t.orderBy(this.orderby));const{current:i,size:n}=this.paginationInternal,o={};this.getcount&&(o.getCount=this.getcount);const s={limitLevel:this.limitlevel,startWith:this.startwith};return this.gettree&&(o.getTree=s),this.gettreepath&&(o.getTreePath=s),t=t.skip(n*(i-1)).limit(n),e?(t=t.getTemp(o),t.udb=this):t=t.get(o),t},setResult(e){0===e.code?this._execLoadDataSuccess(e):this._execLoadDataFail(new Error(e.message))},_execLoadData(e,t){if(!this.loading)return this.loading=!0,this.errorMessage="",this._getExec().then((i=>{this.loading=!1,this._execLoadDataSuccess(i.result,e,t)})).catch((t=>{this.loading=!1,this._execLoadDataFail(t,e)}))},_execLoadDataSuccess(e,t,i){const{data:n,count:o}=e;this._isEnded=void 0!==o?this.paginationInternal.current*this.paginationInternal.size>=o:n.length<this.pageSize,this.hasMore=!this._isEnded;const a=this.getone?n.length?n[0]:void 0:n;this.getcount&&(this.paginationInternal.count=o),t&&t(a,this._isEnded,this.paginationInternal),this._dispatchEvent(O,a),this.getone||this.pageData===N||i?this.dataList=a:this.dataList.push(...a)},_execLoadDataFail(e,t){this.errorMessage=e,t&&t(),this.$emit($,e)},_getExec(){return this.getTemp(!1)},_execRemove(e,t,i,n,s,c,d,u){if(!this.collection||!e)return;const h=A(e)?e:[e];if(!h.length)return;d&&o({mask:!0,title:u});const p=a.database(this.spaceInfo),g=p.command;let m=p;t&&(m=m.action(t)),m.collection(this.mainCollection).where({_id:g.in(h)}).remove().then((e=>{i&&i(e.result),this.pageData===N?this.refresh():this.removeData(h)})).catch((e=>{n&&n(e),c&&l({content:e.message,showCancel:!1})})).finally((()=>{d&&r(),s&&s()}))},removeData(e){const t=e.slice(0),i=this.dataList;for(let n=i.length-1;n>=0;n--){const e=t.indexOf(i[n]._id);e>=0&&(i.splice(n,1),t.splice(e,1))}},_dispatchEvent(e,t){this._changeDataFunction?this._changeDataFunction(t,this._isEnded,this.paginationInternal):this.$emit(e,t,this._isEnded,this.paginationInternal)}}},[["render",function(e,t,i,n,o,a){const s=g;return c(),d(s,null,{default:u((()=>[h(e.$slots,"default",{options:i.options,data:n.dataList,pagination:o.paginationInternal,loading:o.loading,hasMore:o.hasMore,error:o.errorMessage})])),_:3})}]]);const q=B({onLoad(){},computed:{isWidescreen:()=>m.isWidescreen},data:()=>({loadMoreStatus:"more",udbWhere:""}),onPullDownRefresh(){this.$refs.udb.loadData({clear:!0},(()=>{f()}))},onReachBottom(){this.$refs.udb.loadMore()},onNavigationBarButtonTap(e){if(console.log(e),e.index){let e=y();console.log("data.keys",JSON.stringify(e.keys)),e.keys.forEach((e=>{(e.includes("uni-im-msg:")||e.includes("uni-im-conversation"))&&(_(e),console.log(C(e)))})),s({title:"clear storage ok",icon:"none"})}else v({url:"/uni_modules/uni-id-pages/pages/login/login-withpwd",complete:e=>{console.log(e)}})},methods:{handleLoad(e,t){this.loadMoreStatus=t?"noMore":"more"},async toChat(e){const t=await m.conversation.get({friend_uid:e});console.log("currentConversation",t),this.isWidescreen?v({url:"/uni_modules/uni-im/pages/index/index?conversation_id="+t.id}):v({url:"/uni_modules/uni-im/pages/chat/chat?conversation_id="+t.id})},toAdd(){v({url:"../uni-id-users/add",events:{refreshData:()=>{this.$refs.udb.loadData({clear:!0})}}})}}},[["render",function(e,t,i,n,o,a){const s=x,l=g,r=I(k("uni-list-chat"),E),h=I(k("uni-list"),T),p=I(k("uni-load-more"),j),m=I(k("unicloud-db"),P);return c(),d(l,null,{default:u((()=>[b(m,{ref:"udb",onLoad:a.handleLoad,collection:"uni-id-users",field:"_id,nickname,avatar_file",where:o.udbWhere},{default:u((({data:e,loading:t,pagination:i,error:n,options:g})=>[n?(c(),d(l,{key:0,class:"error"},{default:u((()=>[b(s,null,{default:u((()=>[w(S(n.message),1)])),_:2},1024)])),_:2},1024)):(c(),d(h,{key:1},{default:u((()=>[(c(!0),D(M,null,L(e,((e,t)=>(c(),d(r,{key:e._id,link:"",title:e.nickname,avatar:e.avatar_file?e.avatar_file.url:"/uni_modules/uni-im/static/avatarUrl.png",onClick:t=>a.toChat(e._id)},null,8,["title","avatar","onClick"])))),128))])),_:2},1024)),b(p,{status:t?"loading":o.loadMoreStatus},null,8,["status"])])),_:1},8,["onLoad","where"])])),_:1})}]]);export{q as default};
