import{g as e,J as i,ax as t,aj as a,W as o,ak as s,A as n,a$ as l,d as r,e as u,o as c,c as d,w as p,a as h,n as m,af as f,b2 as g,f as y,h as b,H as _,i as w,Q as v,j as k,p as I,F as x}from"./index-40b5c4cd.js";import{_ as C}from"./cloud-image.bb0ddc22.js";import{_ as M}from"./uni-icons.4f8d1bfc.js";import{_ as S}from"./_plugin-vue_export-helper.1b428a4d.js";import{a as P}from"./uni-list-item.88aca6c2.js";import{_ as B}from"./uni-list.8cb35de1.js";import{_ as j}from"./uni-popup-dialog.91400977.js";import{_ as A}from"./uni-popup.52abe24b.js";const N=S({data:()=>({isPC:!1}),props:{width:{type:String,default:()=>"50px"},height:{type:String,default:()=>"50px"},border:{type:Boolean,default:()=>!1}},async mounted(){this.isPC=!["ios","android"].includes(e().platform)},computed:{hasLogin:()=>i.hasLogin,userInfo:()=>i.userInfo,avatar_file:()=>i.userInfo.avatar_file},methods:{setAvatarFile(e){t.updateUserInfo({avatar_file:e})},async bindchooseavatar(e){let i=e.detail.avatarUrl,t={extname:i.split(".")[i.split(".").length-1],name:"",url:""},n=this.userInfo._id+""+Date.now();t.name=n;try{a({title:"更新中",mask:!0});let{fileID:e}=await o.uploadFile({filePath:i,cloudPath:n,fileType:"image"});t.url=e,s()}catch(l){console.error(l)}console.log("avatar_file",t),this.setAvatarFile(t)},uploadAvatarImg(e){if(!this.hasLogin)return n({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd"});const i={quality:100,width:600,height:600,resize:!0};l({count:1,crop:i,success:async e=>{let t=e.tempFiles[0],l={extname:t.name.split(".")[t.name.split(".").length-1]},r=e.tempFilePaths[0];this.isPC||(r=await new Promise((e=>{n({url:"/uni_modules/uni-id-pages/pages/userinfo/cropImage/cropImage?path="+r+`&options=${JSON.stringify(i)}`,animationType:"fade-in",events:{success:i=>{e(i)}},complete(e){console.log(e)}})})));let u=this.userInfo._id+""+Date.now();l.name=u,a({title:"更新中",mask:!0});let{fileID:c}=await o.uploadFile({filePath:r,cloudPath:u,fileType:"image"});l.url=c,s(),this.setAvatarFile(l)}})}}},[["render",function(e,i,t,a,o,s){const n=r(u("cloud-image"),C),l=r(u("uni-icons"),M),g=f;return c(),d(g,{"open-type":"chooseAvatar",onChooseavatar:s.bindchooseavatar,onClick:s.uploadAvatarImg,class:m(["box",{showBorder:t.border}]),style:h({width:t.width,height:t.height,lineHeight:t.height})},{default:p((()=>[s.avatar_file?(c(),d(n,{key:0,src:s.avatar_file.url,width:t.width,height:t.height},null,8,["src","width","height"])):(c(),d(l,{key:1,style:h({width:t.width,height:t.height,lineHeight:t.height}),class:"chooseAvatar",type:"plusempty",size:"30",color:"#dddddd"},null,8,["style"]))])),_:1},8,["onChooseavatar","onClick","class","style"])}],["__scopeId","data-v-b0252f8e"]]);o.database().collection("uni-id-users");const T=o.importObject("uni-id-co");const L=S({emits:["success"],computed:{},data:()=>({}),methods:{beforeGetphonenumber:async()=>await new Promise(((e,i)=>{a({mask:!0}),wx.checkSession({success(){e(),s()},fail(){g({success({code:t}){o.importObject("uni-id-co",{customUI:!0}).loginByWeixin({code:t}).then((i=>{e()})).catch((e=>{console.log(e),i()})).finally((e=>{s()}))},fail:e=>{console.error(e),i()}})}})})),async bindMobileByMpWeixin(e){"getPhoneNumber:ok"==e.detail.errMsg?(await this.beforeGetphonenumber(),T.bindMobileByMpWeixin(e.detail).then((e=>{this.$emit("success")})).finally((e=>{this.closeMe()}))):this.closeMe()},async open(){this.$refs.popup.open()},closeMe(e){this.$refs.popup.close()}}},[["render",function(e,i,t,a,o,s){const n=_,l=f,h=w,m=r(u("uni-popup"),A);return c(),d(m,{ref:"popup",type:"bottom"},{default:p((()=>[y(h,{class:"box"},{default:p((()=>[y(n,{class:"headBox"},{default:p((()=>[b("绑定资料")])),_:1}),y(n,{class:"tip"},{default:p((()=>[b("将一键获取你的手机号码绑定你的个人资料")])),_:1}),y(h,{class:"btnBox"},{default:p((()=>[y(n,{onClick:s.closeMe,class:"close"},{default:p((()=>[b("关闭")])),_:1},8,["onClick"]),y(l,{class:"agree uni-btn",type:"primary","open-type":"getPhoneNumber",onGetphonenumber:s.bindMobileByMpWeixin},{default:p((()=>[b("获取")])),_:1},8,["onGetphonenumber"])])),_:1})])),_:1})])),_:1},512)}],["__scopeId","data-v-8913b1c7"]]),U=o.importObject("uni-id-co");const F=S({computed:{userInfo:()=>i.userInfo,realNameStatus(){return this.userInfo.realNameAuth?this.userInfo.realNameAuth.authStatus:0}},data:()=>({univerifyStyle:{authButton:{title:"本机号码一键绑定"},otherLoginButton:{title:"其他号码绑定"}},hasPwd:!1,showLoginManage:!1,setNicknameIng:!1}),async onShow(){this.univerifyStyle.authButton.title="本机号码一键绑定",this.univerifyStyle.otherLoginButton.title="其他号码绑定"},async onLoad(e){e.showLoginManage&&(this.showLoginManage=!0);let i=await U.getAccountInfo();this.hasPwd=i.isPasswordSet},methods:{login(){n({url:"/pages/login/login",complete:e=>{}})},logout(){t.logout()},bindMobileSuccess(){t.updateUserInfo()},changePassword(){n({url:"/uni_modules/uni-id-pages/pages/userinfo/change_pwd/change_pwd",complete:e=>{}})},bindMobile(){this.bindMobileBySmsCode()},univerify(){g({provider:"univerify",univerifyStyle:this.univerifyStyle,success:async e=>{U.bindMobileByUniverify(e.authResult).then((e=>{t.updateUserInfo()})).catch((e=>{console.log(e)})).finally((e=>{uni.closeAuthView()}))},fail:e=>{console.log(e),"30002"!=e.code&&"30001"!=e.code||this.bindMobileBySmsCode()}})},bindMobileBySmsCode(){n({url:"./bind-mobile/bind-mobile"})},setNickname(e){e?(t.updateUserInfo({nickname:e}),this.setNicknameIng=!1,this.$refs.dialog.close()):this.$refs.dialog.open()},deactivate(){n({url:"/uni_modules/uni-id-pages/pages/userinfo/deactivate/deactivate"})},async bindThirdAccount(e){const i=o.importObject("uni-id-co"),a={weixin:"wx_openid",alipay:"ali_openid",apple:"apple_openid",qq:"qq_openid"}[e.toLowerCase()];this.userInfo[a]?(await i["unbind"+e](),await t.updateUserInfo()):g({provider:e.toLowerCase(),onlyAuthorize:!0,success:async a=>{const o=await i["bind"+e]({code:a.code});o.errCode&&v({title:o.errMsg||"绑定失败",duration:3e3}),await t.updateUserInfo()},fail:async e=>{console.log(e),s()}})},realNameVerify(){n({url:"/uni_modules/uni-id-pages/pages/userinfo/realname-verify/realname-verify"})}}},[["render",function(e,i,t,a,o,s){const n=r(u("uni-id-pages-avatar"),N),l=w,h=r(u("uni-list-item"),P),m=r(u("uni-list"),B),g=r(u("uni-popup-dialog"),j),_=r(u("uni-popup"),A),v=r(u("uni-id-pages-bind-mobile"),L),C=f;return c(),d(l,{class:"uni-content"},{default:p((()=>[y(l,{class:"avatar"},{default:p((()=>[y(n,{width:"260rpx",height:"260rpx"})])),_:1}),y(m,null,{default:p((()=>[y(h,{class:"item",onClick:i[0]||(i[0]=e=>s.setNickname("")),title:"昵称",rightText:s.userInfo.nickname||"未设置",link:""},null,8,["rightText"]),y(h,{class:"item",onClick:s.bindMobile,title:"手机号",rightText:s.userInfo.mobile||"未绑定",link:""},null,8,["onClick","rightText"]),s.userInfo.email?(c(),d(h,{key:0,class:"item",title:"电子邮箱",rightText:s.userInfo.email},null,8,["rightText"])):k("",!0),o.hasPwd?(c(),d(h,{key:1,class:"item",onClick:s.changePassword,title:"修改密码",link:""},null,8,["onClick"])):k("",!0)])),_:1}),y(m,{class:"mt10"},{default:p((()=>[y(h,{onClick:s.deactivate,title:"注销账号",link:"navigateTo"},null,8,["onClick"])])),_:1}),y(_,{ref:"dialog",type:"dialog"},{default:p((()=>[y(g,{mode:"input",value:s.userInfo.nickname,onConfirm:s.setNickname,inputType:o.setNicknameIng?"nickname":"text",title:"设置昵称",placeholder:"请输入要设置的昵称"},null,8,["value","onConfirm","inputType"])])),_:1},512),y(v,{ref:"bind-mobile-by-sms",onSuccess:s.bindMobileSuccess},null,8,["onSuccess"]),o.showLoginManage?(c(),I(x,{key:0},[s.userInfo._id?(c(),d(C,{key:0,onClick:s.logout},{default:p((()=>[b("退出登录")])),_:1},8,["onClick"])):(c(),d(C,{key:1,onClick:s.login},{default:p((()=>[b("去登录")])),_:1},8,["onClick"]))],64)):k("",!0)])),_:1})}],["__scopeId","data-v-734175d5"]]);export{F as default};
